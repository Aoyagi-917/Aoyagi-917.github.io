<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ¬åœ°è¯„è®ºç³»ç»Ÿ</title>
    <!-- å¼•å…¥Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- é…ç½®Tailwindè‡ªå®šä¹‰é¢œè‰² -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#64748b',
                        neutral: '#f1f5f9',
                    },
                }
            }
        }
    </script>
    
    <!-- è‡ªå®šä¹‰å·¥å…·ç±» -->
    <style type="text/tailwindcss">
        @layer utilities {
            .comment-shadow {
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            }
            .reply-indent {
                margin-left: 1.5rem;
                border-left: 2px solid #e2e8f0;
                padding-left: 1rem;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 md:p-8">
    <div class="max-w-3xl mx-auto bg-white rounded-xl p-6 shadow-md">
        <h1 class="text-2xl font-bold text-gray-800 mb-6">è¯„è®ºåŒº</h1>
        
        <!-- è¯„è®ºè¾“å…¥åŒº -->
        <div class="mb-8 bg-neutral rounded-lg p-4">
            <div class="mb-4">
                <label for="comment-content" class="block text-sm font-medium text-gray-700 mb-1">è¯„è®ºå†…å®¹</label>
                <textarea 
                    id="comment-content" 
                    rows="3" 
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50"
                    placeholder="åˆ†äº«ä½ çš„æƒ³æ³•..."></textarea>
            </div>
            <div class="mb-4">
                <label for="comment-author" class="block text-sm font-medium text-gray-700 mb-1">æ˜µç§°</label>
                <input 
                    type="text" 
                    id="comment-author" 
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50"
                    placeholder="ä½ çš„æ˜µç§°">
            </div>
            <button id="submit-comment" class="bg-primary text-white px-4 py-2 rounded-md hover:bg-primary/90 transition-colors">
                å‘å¸ƒè¯„è®º
            </button>
        </div>
        
        <!-- è¯„è®ºåˆ—è¡¨ -->
        <div id="comments-container" class="space-y-6">
            <!-- è¯„è®ºä¼šé€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            <div class="text-center text-gray-500 py-8" id="empty-state">
                <span class="text-4xl mb-2 opacity-30">ğŸ’¬</span>
                <p>è¿˜æ²¡æœ‰è¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘å§~</p>
            </div>
        </div>
        
        <!-- åˆ†é¡µæ§ä»¶ -->
        <div id="pagination" class="flex justify-center mt-8 gap-2 hidden">
            <button id="prev-page" class="px-3 py-1 border rounded-md hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">ä¸Šä¸€é¡µ</button>
            <span id="page-info" class="px-3 py-1"></span>
            <button id="next-page" class="px-3 py-1 border rounded-md hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">ä¸‹ä¸€é¡µ</button>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–localStorageï¼ˆå¦‚æœæ²¡æœ‰æ•°æ®åˆ™åˆ›å»ºç©ºæ•°ç»„ï¼‰
        if (!localStorage.getItem('comments')) {
            localStorage.setItem('comments', JSON.stringify([]));
        }

        // åˆ†é¡µé…ç½®
        const PAGE_SIZE = 10;
        let currentPage = 1;

        // è·å–å½“å‰æ—¶é—´ï¼ˆç®€åŒ–ç‰ˆï¼Œç¡®ä¿æ—¶åŒºæ­£ç¡®ï¼‰
        function getCurrentTime() {
            const now = new Date();
            return now.toISOString().slice(0, 19).replace('T', ' ');
        }

        // ç”Ÿæˆå”¯ä¸€ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }

        // æ£€æŸ¥è¯„è®ºæ˜¯å¦å¯ä»¥æ’¤å›ï¼ˆç®€åŒ–é€»è¾‘ï¼Œç¡®ä¿æŒ‰é’®æ˜¾ç¤ºï¼‰
        function canWithdraw(timeString) {
            // ä¸ºäº†ç¡®ä¿æŒ‰é’®å¯è§ï¼Œè¿™é‡Œæš‚æ—¶æ”¹ä¸ºå§‹ç»ˆè¿”å›true
            // å®é™…ä½¿ç”¨æ—¶å¯ä»¥æ”¹ä¸º5åˆ†é’Ÿé™åˆ¶ï¼š
            // const commentTime = new Date(timeString).getTime();
            // const now = new Date().getTime();
            // return now - commentTime <= 1000 * 60 * 5; // 5åˆ†é’Ÿ
            
            return true; // å§‹ç»ˆæ˜¾ç¤ºæ’¤å›æŒ‰é’®
        }

        // è·å–å½“å‰é¡µçš„è¯„è®º
        function getCurrentPageComments() {
            const comments = JSON.parse(localStorage.getItem('comments') || '[]');
            const startIndex = (currentPage - 1) * PAGE_SIZE;
            const endIndex = startIndex + PAGE_SIZE;
            return comments.slice(startIndex, endIndex);
        }

        // è·å–æ€»é¡µæ•°
        function getTotalPages() {
            const comments = JSON.parse(localStorage.getItem('comments') || '[]');
            return Math.ceil(comments.length / PAGE_SIZE);
        }

        // æ›´æ–°åˆ†é¡µæ§ä»¶çŠ¶æ€
        function updatePagination() {
            const totalPages = getTotalPages();
            const paginationEl = document.getElementById('pagination');
            const prevBtn = document.getElementById('prev-page');
            const nextBtn = document.getElementById('next-page');
            const pageInfo = document.getElementById('page-info');

            paginationEl.classList.toggle('hidden', totalPages <= 1);
            
            if (totalPages <= 1) return;

            pageInfo.textContent = `ç¬¬ ${currentPage} / ${totalPages} é¡µ`;
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;
        }

        // æ¸²æŸ“è¯„è®ºåˆ—è¡¨
        function renderComments() {
            const commentsContainer = document.getElementById('comments-container');
            const allComments = JSON.parse(localStorage.getItem('comments') || '[]');
            const currentComments = getCurrentPageComments();
            const emptyState = document.getElementById('empty-state');

            // æ¸…ç©ºå®¹å™¨ï¼ˆä¿ç•™empty-stateï¼‰
            Array.from(commentsContainer.children).forEach(child => {
                if (child.id !== 'empty-state') child.remove();
            });

            // æ˜¾ç¤º/éšè—ç©ºçŠ¶æ€
            emptyState.style.display = allComments.length === 0 ? 'block' : 'none';

            // æ¸²æŸ“å½“å‰é¡µçš„æ¯æ¡è¯„è®º
            currentComments.forEach(comment => {
                const commentEl = createCommentElement(comment);
                commentsContainer.appendChild(commentEl);
            });

            updatePagination();
        }

        // åˆ›å»ºå•æ¡è¯„è®ºå…ƒç´ 
        function createCommentElement(comment, isReply = false) {
            const div = document.createElement('div');
            div.className = `comment-shadow rounded-lg p-4 ${isReply ? 'reply-indent mt-3' : ''}`;
            div.dataset.id = comment.id;

            // ç¡®ä¿å¿…è¦å±æ€§å­˜åœ¨
            comment.replies = comment.replies || [];
            comment.showAllReplies = comment.showAllReplies || false;
            
            // æ£€æŸ¥æ˜¯å¦å¯ä»¥æ’¤å›ï¼ˆç°åœ¨å§‹ç»ˆä¸ºtrueï¼‰
            const withdrawable = canWithdraw(comment.time);
            
            // å¤„ç†å›å¤æŠ˜å é€»è¾‘
            const replies = comment.replies;
            const showAllReplies = comment.showAllReplies;
            const visibleReplies = showAllReplies ? replies : replies.slice(0, 3);
            const hasMoreReplies = replies.length > 3;
            
            div.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <h3 class="font-semibold text-gray-800">${comment.author}</h3>
                    <span class="text-xs text-gray-500">${comment.time}</span>
                </div>
                <p class="text-gray-700 mb-3">${comment.content}</p>
                <div class="flex items-center gap-4 text-sm">
                    <button class="like-btn flex items-center gap-1 text-gray-600 hover:text-red-500 transition-colors" 
                            data-id="${comment.id}">
                        <span>${comment.isLiked ? 'â¤ï¸' : 'ğŸ¤'}</span>
                        <span>${comment.likes}</span>
                    </button>
                    <button class="reply-btn flex items-center gap-1 text-gray-600 hover:text-primary transition-colors">
                        <span>ğŸ’¬</span>
                        <span>å›å¤</span>
                    </button>
                    ${withdrawable ? `
                    <button class="withdraw-btn flex items-center gap-1 text-gray-600 hover:text-red-500 transition-colors">
                        <span>ğŸ—‘ï¸</span>
                        <span>æ’¤å›</span>
                    </button>
                    ` : ''}
                </div>
                <!-- å›å¤è¾“å…¥æ¡†ï¼ˆé»˜è®¤éšè—ï¼‰ -->
                <div class="reply-form mt-3 hidden">
                    <textarea class="reply-content w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-primary/50"
                              rows="2" placeholder="å›å¤ @${comment.author}..."></textarea>
                    <div class="flex gap-2 mt-2">
                        <input type="text" class="reply-author w-1/3 px-3 py-1 border border-gray-300 rounded-md text-sm focus:outline-none"
                               placeholder="ä½ çš„æ˜µç§°">
                        <button class="submit-reply bg-primary/90 text-white px-3 py-1 rounded-md text-sm hover:bg-primary transition-colors">
                            å›å¤
                        </button>
                        <button class="cancel-reply text-gray-500 px-3 py-1 rounded-md text-sm hover:bg-gray-100 transition-colors">
                            å–æ¶ˆ
                        </button>
                    </div>
                </div>
                <!-- å›å¤åˆ—è¡¨ -->
                <div class="replies mt-4 space-y-2">
                    ${visibleReplies.map(reply => createCommentElement(reply, true).outerHTML).join('')}
                    ${hasMoreReplies ? `
                        <button class="toggle-replies text-sm text-primary mt-1 flex items-center gap-1" data-id="${comment.id}">
                            <span>â¬‡ï¸</span>
                            <span>æ˜¾ç¤º${showAllReplies ? 'æ›´å°‘' : 'å…¨éƒ¨'}å›å¤ (${showAllReplies ? 3 : replies.length - 3}æ¡)</span>
                        </button>
                    ` : ''}
                </div>
            `;

            // ç»‘å®šå›å¤æŠ˜å /å±•å¼€äº‹ä»¶
            if (hasMoreReplies) {
                const toggleBtn = div.querySelector('.toggle-replies');
                toggleBtn.addEventListener('click', function() {
                    const commentId = this.dataset.id;
                    toggleRepliesVisibility(commentId);
                });
            }

            return div;
        }

        // å›å¤æŠ˜å /å±•å¼€å‡½æ•°
        function toggleRepliesVisibility(commentId) {
            const comments = JSON.parse(localStorage.getItem('comments') || '[]');
            
            // é€’å½’æŸ¥æ‰¾è¯„è®ºå¹¶åˆ‡æ¢æ˜¾ç¤ºçŠ¶æ€
            function findAndToggle(commentList) {
                for (let comment of commentList) {
                    if (comment.id === commentId) {
                        comment.showAllReplies = !comment.showAllReplies;
                        return true;
                    }
                    if (comment.replies && comment.replies.length > 0) {
                        if (findAndToggle(comment.replies)) {
                            return true;
                        }
                    }
                }
                return false;
            }
            
            findAndToggle(comments);
            localStorage.setItem('comments', JSON.stringify(comments));
            renderComments();
        }

        // å‘å¸ƒè¯„è®º
        function publishComment(content, author) {
            if (!content.trim() || !author.trim()) {
                alert('è¯·è¾“å…¥è¯„è®ºå†…å®¹å’Œæ˜µç§°');
                return;
            }

            const comments = JSON.parse(localStorage.getItem('comments') || '[]');
            const newComment = {
                id: generateId(),
                content: content.trim(),
                author: author.trim(),
                time: getCurrentTime(),
                likes: 0,
                isLiked: false,
                replies: [],
                showAllReplies: false
            };

            comments.unshift(newComment);
            localStorage.setItem('comments', JSON.stringify(comments));
            
            currentPage = 1;
            renderComments();

            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('comment-content').value = '';
            document.getElementById('comment-author').value = '';
        }

        // å‘å¸ƒå›å¤
        function publishReply(commentId, content, author) {
            if (!content.trim() || !author.trim()) {
                alert('è¯·è¾“å…¥å›å¤å†…å®¹å’Œæ˜µç§°');
                return;
            }

            const comments = JSON.parse(localStorage.getItem('comments') || '[]');
            const newReply = {
                id: generateId(),
                content: content.trim(),
                author: author.trim(),
                time: getCurrentTime(),
                likes: 0,
                isLiked: false,
                replies: [],
                showAllReplies: false
            };

            // é€’å½’æŸ¥æ‰¾è¯„è®ºå¹¶æ·»åŠ å›å¤
            function findAndAddReply(commentList) {
                for (let i = 0; i < commentList.length; i++) {
                    if (commentList[i].id === commentId) {
                        commentList[i].replies.unshift(newReply);
                        return true;
                    }
                    if (commentList[i].replies && commentList[i].replies.length > 0 && findAndAddReply(commentList[i].replies)) {
                        return true;
                    }
                }
                return false;
            }

            findAndAddReply(comments);
            localStorage.setItem('comments', JSON.stringify(comments));
            renderComments();
        }

        // ç‚¹èµåŠŸèƒ½
        function toggleLike(commentId) {
            const comments = JSON.parse(localStorage.getItem('comments') || '[]');

            function findAndToggleLike(commentList) {
                for (let comment of commentList) {
                    if (comment.id === commentId) {
                        comment.likes += comment.isLiked ? -1 : 1;
                        comment.isLiked = !comment.isLiked;
                        return true;
                    }
                    if (comment.replies && comment.replies.length > 0 && findAndToggleLike(comment.replies)) {
                        return true;
                    }
                }
                return false;
            }

            findAndToggleLike(comments);
            localStorage.setItem('comments', JSON.stringify(comments));
            renderComments();
        }

        // æ’¤å›è¯„è®º/å›å¤åŠŸèƒ½
        function withdrawComment(commentId) {
            if (!confirm('ç¡®å®šè¦æ’¤å›è¿™æ¡è¯„è®ºå—ï¼Ÿ')) {
                return;
            }

            const comments = JSON.parse(localStorage.getItem('comments') || '[]');

            function findAndRemoveComment(commentList) {
                for (let i = 0; i < commentList.length; i++) {
                    if (commentList[i].id === commentId) {
                        commentList.splice(i, 1);
                        return true;
                    }
                    if (commentList[i].replies && commentList[i].replies.length > 0 && findAndRemoveComment(commentList[i].replies)) {
                        return true;
                    }
                }
                return false;
            }

            findAndRemoveComment(comments);
            localStorage.setItem('comments', JSON.stringify(comments));
            
            // è°ƒæ•´å½“å‰é¡µ
            const totalPages = getTotalPages();
            if (currentPage > totalPages && totalPages > 0) {
                currentPage = totalPages;
            }
            
            renderComments();
        }

        // äº‹ä»¶ç›‘å¬
        document.addEventListener('DOMContentLoaded', () => {
            // åˆå§‹æ¸²æŸ“è¯„è®º
            renderComments();

            // å‘å¸ƒè¯„è®ºæŒ‰é’®
            document.getElementById('submit-comment').addEventListener('click', () => {
                const content = document.getElementById('comment-content').value;
                const author = document.getElementById('comment-author').value;
                publishComment(content, author);
            });

            // åˆ†é¡µæŒ‰é’®äº‹ä»¶
            document.getElementById('prev-page').addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderComments();
                }
            });

            document.getElementById('next-page').addEventListener('click', () => {
                const totalPages = getTotalPages();
                if (currentPage < totalPages) {
                    currentPage++;
                    renderComments();
                }
            });

            // ç‚¹å‡»äº‹ä»¶å§”æ‰˜
            const commentsContainer = document.getElementById('comments-container');
            
            // ç‚¹èµæŒ‰é’®äº‹ä»¶
            commentsContainer.addEventListener('click', (e) => {
                const likeBtn = e.target.closest('.like-btn');
                if (likeBtn) {
                    const commentId = likeBtn.dataset.id;
                    toggleLike(commentId);
                }
            });
            
            // å›å¤æŒ‰é’®äº‹ä»¶
            commentsContainer.addEventListener('click', (e) => {
                const replyBtn = e.target.closest('.reply-btn');
                if (replyBtn) {
                    const commentEl = replyBtn.closest('[data-id]');
                    const replyForm = commentEl.querySelector('.reply-form');
                    // éšè—å…¶ä»–æ‰€æœ‰å›å¤æ¡†
                    document.querySelectorAll('.reply-form').forEach(form => {
                        if (form !== replyForm) form.classList.add('hidden');
                    });
                    // åˆ‡æ¢å½“å‰å›å¤æ¡†æ˜¾ç¤ºçŠ¶æ€
                    replyForm.classList.toggle('hidden');
                }
            });
            
            // å–æ¶ˆå›å¤äº‹ä»¶
            commentsContainer.addEventListener('click', (e) => {
                const cancelBtn = e.target.closest('.cancel-reply');
                if (cancelBtn) {
                    cancelBtn.closest('.reply-form').classList.add('hidden');
                }
            });
            
            // æäº¤å›å¤äº‹ä»¶
            commentsContainer.addEventListener('click', (e) => {
                const submitReplyBtn = e.target.closest('.submit-reply');
                if (submitReplyBtn) {
                    const replyForm = submitReplyBtn.closest('.reply-form');
                    const commentEl = replyForm.closest('[data-id]');
                    const commentId = commentEl.dataset.id;
                    const content = replyForm.querySelector('.reply-content').value;
                    const author = replyForm.querySelector('.reply-author').value;

                    publishReply(commentId, content, author);
                    replyForm.classList.add('hidden');
                    replyForm.querySelector('.reply-content').value = '';
                    replyForm.querySelector('.reply-author').value = '';
                }
            });
            
            // æ’¤å›æŒ‰é’®äº‹ä»¶
            commentsContainer.addEventListener('click', (e) => {
                const withdrawBtn = e.target.closest('.withdraw-btn');
                if (withdrawBtn) {
                    const commentEl = withdrawBtn.closest('[data-id]');
                    const commentId = commentEl.dataset.id;
                    withdrawComment(commentId);
                }
            });

            // æ·»åŠ æµ‹è¯•æ•°æ®
            // addTestComments();
        });

        // æµ‹è¯•ç”¨ï¼šæ·»åŠ æµ‹è¯•è¯„è®ºæ•°æ®
        function addTestComments() {
            const testComments = [];
            for (let i = 0; i < 5; i++) {
                const replies = [];
                for (let j = 0; j < 5; j++) {
                    replies.push({
                        id: generateId(),
                        content: `è¿™æ˜¯ç¬¬${i+1}æ¡è¯„è®ºçš„ç¬¬${j+1}æ¡å›å¤`,
                        author: `æµ‹è¯•ç”¨æˆ·${j+1}`,
                        time: getCurrentTime(),
                        likes: Math.floor(Math.random() * 10),
                        isLiked: false,
                        replies: [],
                        showAllReplies: false
                    });
                }
                
                testComments.push({
                    id: generateId(),
                    content: `è¿™æ˜¯ç¬¬${i+1}æ¡æµ‹è¯•è¯„è®ºï¼Œç”¨äºæµ‹è¯•åˆ†é¡µå’Œå›å¤åŠŸèƒ½`,
                    author: `æµ‹è¯•ç”¨æˆ·`,
                    time: getCurrentTime(),
                    likes: Math.floor(Math.random() * 20),
                    isLiked: false,
                    replies: replies,
                    showAllReplies: false
                });
            }
            
            localStorage.setItem('comments', JSON.stringify(testComments));
            renderComments();
        }
    </script>
</body>
</html>
