<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸€èµ·è¯„è®ºÏ†(ã‚œâ–½ã‚œ*)â™ª</title>
    <!-- æ³¨æ„ï¼šåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå»ºè®®ä½¿ç”¨Tailwind CLIæˆ–PostCSSæ’ä»¶è€ŒéCDN -->
    <!-- å‚è€ƒï¼šhttps://tailwindcss.com/docs/installation -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#64748b',
                        neutral: '#f1f5f9',
                        danger: '#ef4444',
                        success: '#10b981',
                        warning: '#f59e0b',
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .comment-shadow { box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); }
            .reply-indent { margin-left: 1.5rem; border-left: 2px solid #e2e8f0; padding-left: 1rem; }
            .glass-effect { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(8px); }
            .collapsed-content { display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; overflow: hidden; }
            .image-loading { background: #f1f5f9; animation: pulse 1.5s infinite; }
            @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
            .error-message { color: #ef4444; font-size: 0.875rem; margin-top: 0.25rem; }
            .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
            .admin-badge { background-color: #3b82f6; color: white; font-size: 0.7rem; padding: 0 3px; border-radius: 3px; margin-left: 5px; }
            .pinned-badge { background-color: #f59e0b; color: white; font-size: 0.7rem; padding: 0 3px; border-radius: 3px; margin-right: 5px; }
            .clock { width: 120px; height: 120px; border-radius: 50%; border: 4px solid #3b82f6; position: relative; margin: 0 auto; }
            .clock-hand { position: absolute; background-color: #3b82f6; transform-origin: bottom center; border-radius: 5px; }
            .hour-hand { width: 4px; height: 30px; top: 30px; left: 58px; }
            .minute-hand { width: 3px; height: 40px; top: 20px; left: 58.5px; }
            .second-hand { width: 2px; height: 45px; top: 15px; left: 59px; background-color: #ef4444; }
            .clock-center { width: 10px; height: 10px; background-color: #3b82f6; border-radius: 50%; position: absolute; top: 55px; left: 55px; }
            .music-player { background-color: rgba(255, 255, 255, 0.9); border-radius: 8px; padding: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
            .song-info { margin-bottom: 10px; }
            .song-title { font-weight: bold; color: #3b82f6; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
            .song-artist { font-size: 0.85rem; color: #64748b; }
            .lyrics-container { 
                height: 180px; 
                overflow-y: auto; /* å…è®¸å‚ç›´æ»šåŠ¨ */
                position: relative; 
                margin: 10px 0; 
                text-align: center;
                scrollbar-width: thin; /* ç»†æ»šåŠ¨æ¡ */
                scrollbar-color: #3b82f6 #f1f5f9; /* æ»šåŠ¨æ¡é¢œè‰² */
            }
            /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
            .lyrics-container::-webkit-scrollbar {
                width: 4px;
            }
            .lyrics-container::-webkit-scrollbar-track {
                background: #f1f5f9;
                border-radius: 10px;
            }
            .lyrics-container::-webkit-scrollbar-thumb {
                background: #3b82f6;
                border-radius: 10px;
            }
            .lyrics-container::-webkit-scrollbar-thumb:hover {
                background: #2563eb;
            }
            .lyrics-scroll { 
                position: relative; 
                width: 100%; 
                padding: 20px 0; /* å¢åŠ ä¸Šä¸‹å†…è¾¹è·ï¼Œæ–¹ä¾¿æ»šåŠ¨åˆ°é¡¶éƒ¨å’Œåº•éƒ¨ */
            }
            .lyric-line { 
                padding: 4px 0; 
                font-size: 0.9rem; 
                color: #4b5563; 
                transition: all 0.3s ease; 
                min-height: 24px; /* ç¡®ä¿è¡Œé«˜ä¸€è‡´ */
            }
            .lyric-main { transition: all 0.3s ease; }
            .lyric-translation { 
                font-size: 0.8rem; 
                color: #64748b; 
                margin-top: 2px; 
                transition: all 0.3s ease; 
            }
            .lyric-line.active .lyric-main { 
                color: #3b82f6; 
                font-weight: bold; 
                transform: scale(1.05); /* æ´»è·ƒæ­Œè¯ç¨å¾®æ”¾å¤§ */
            }
            .lyric-line.active .lyric-translation { color: #3b82f6; }
            .lyric-line:hover { 
                cursor: pointer; 
                background-color: rgba(59, 130, 246, 0.05); 
            }
            .audio-duration { display: flex; justify-content: space-between; font-size: 0.75rem; color: #64748b; margin-top: 5px; }
            .announcement { background-color: #fff3cd; border-left: 4px solid #f59e0b; padding: 10px 15px; border-radius: 4px; margin-bottom: 1rem; }
            .banned-user { color: #ef4444; font-weight: bold; }
            .admin-panel { position: fixed; top: 0; right: -400px; width: 400px; height: 100%; background-color: white; box-shadow: -2px 0 10px rgba(0,0,0,0.1); transition: right 0.3s ease; z-index: 1000; overflow-y: auto; }
            .admin-panel.open { right: 0; }
            .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 999; display: none; }
            .overlay.show { display: block; }
            .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 1001; display: none; }
            .modal.show { display: block; }
            .avatar-cropper { width: 150px; height: 150px; overflow: hidden; border-radius: 50%; position: relative; margin: 0 auto; }
            .cropper-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 2px dashed rgba(255,255,255,0.5); border-radius: 50%; pointer-events: none; }
            .image-viewer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 2000; }
            .image-viewer.show { display: flex; }
            .image-viewer-content { max-width: 90%; max-height: 90%; position: relative; }
            .image-viewer img { max-width: 100%; max-height: 80vh; object-contain: contain; }
            .close-image-viewer { position: absolute; top: -30px; right: -30px; color: white; font-size: 24px; cursor: pointer; }
            /* è¿›åº¦æ¡æ‹–åŠ¨ç›¸å…³æ ·å¼ */
            .progress-handle { 
                position: absolute; 
                width: 12px; 
                height: 12px; 
                background-color: #3b82f6; 
                border-radius: 50%; 
                top: 50%; 
                transform: translateY(-50%); 
                box-shadow: 0 0 3px rgba(0,0,0,0.2);
                cursor: pointer;
                transition: all 0.1s ease;
            }
            .progress-handle:hover {
                transform: translateY(-50%) scale(1.2);
                box-shadow: 0 0 5px rgba(59, 130, 246, 0.5);
            }
            .progress-container {
                position: relative;
            }
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8 bg-cover bg-center bg-fixed" style="background-image: url('https://img.cdn1.vip/i/68e1c60914798_1759626761.webp');">
    <div id="image-viewer" class="image-viewer">
        <div class="image-viewer-content">
            <span id="close-image-viewer" class="close-image-viewer"><i class="fa fa-times"></i></span>
            <img id="viewer-image" src="" alt="å›¾ç‰‡é¢„è§ˆ">
        </div>
    </div>

    <div id="loading-screen" class="loading-overlay">
        <img src="https://ts1.tc.mm.bing.net/th/id/R-C.0e8edbcaef3e22718de6334626ed6d25?rik=WfHQlKKTgiOM1w&riu=http%3a%2f%2fstatic.oschina.net%2fuploads%2fimg%2f201409%2f26073947_j9gz.gif&ehk=5gMLa5lnbAj7tWHNOvjcM2szRlUEB69ynI9ggjRimVE%3d&risl=&pid=ImgRaw&r=0" alt="åŠ è½½ä¸­" class="w-24 h-24 mb-4">
        <div class="flex items-center">
            <span class="text-primary font-bold text-xl">æ­£åœ¨åŠ è½½</span>
            <span class="text-gray-500 ml-2" id="loading-time">(é¢„è®¡æ‰“å¼€éœ€è¦ <span id="estimated-time">0</span> åˆ†é’Ÿ)</span>
        </div>
    </div>

    <div id="admin-panel" class="admin-panel">
        <div class="p-4 border-b">
            <h2 class="text-xl font-bold">ç®¡ç†å‘˜é¢æ¿</h2>
            <button id="close-admin-panel" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">
                <i class="fa fa-times"></i>
            </button>
        </div>
        <div class="p-4">
            <div class="mb-6">
                <h3 class="font-semibold mb-2">ç»Ÿè®¡ä¿¡æ¯</h3>
                <div class="grid grid-cols-2 gap-2">
                    <div class="bg-gray-100 p-2 rounded">
                        <p class="text-sm text-gray-500">æ³¨å†Œç”¨æˆ·</p>
                        <p class="text-lg font-bold" id="total-users">0</p>
                    </div>
                    <div class="bg-gray-100 p-2 rounded">
                        <p class="text-sm text-gray-500">åœ¨çº¿ç”¨æˆ·</p>
                        <p class="text-lg font-bold" id="online-users">0</p>
                    </div>
                    <div class="bg-gray-100 p-2 rounded">
                        <p class="text-sm text-gray-500">æ€»è¯„è®ºæ•°</p>
                        <p class="text-lg font-bold" id="total-comments">0</p>
                    </div>
                    <div class="bg-gray-100 p-2 rounded">
                        <p class="text-sm text-gray-500">å¾…å®¡æ ¸ä¸¾æŠ¥</p>
                        <p class="text-lg font-bold" id="pending-reports">0</p>
                    </div>
                </div>
            </div>
            
            <div class="mb-6">
                <h3 class="font-semibold mb-2">ç”¨æˆ·ç®¡ç†</h3>
                <div class="mb-2">
                    <input type="text" id="search-user" placeholder="æœç´¢ç”¨æˆ·..." class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div class="max-h-60 overflow-y-auto border border-gray-200 rounded-md p-2" id="user-list"></div>
            </div>
            
            <div class="mb-6">
                <h3 class="font-semibold mb-2">ä¸¾æŠ¥ç®¡ç†</h3>
                <div class="max-h-80 overflow-y-auto border border-gray-200 rounded-md p-2" id="report-list"></div>
            </div>
            
            <div class="mb-6">
                <h3 class="font-semibold mb-2">å…¬å‘Šç®¡ç†</h3>
                <textarea id="announcement-content" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md mb-2" placeholder="è¾“å…¥å…¬å‘Šå†…å®¹..."></textarea>
                <div class="flex gap-2">
                    <button id="save-announcement" class="bg-primary text-white px-3 py-1 rounded text-sm">
                        <i class="fa fa-save mr-1"></i>ä¿å­˜å…¬å‘Š
                    </button>
                    <button id="delete-announcement" class="bg-danger text-white px-3 py-1 rounded text-sm">
                        <i class="fa fa-trash mr-1"></i>åˆ é™¤å…¬å‘Š
                    </button>
                </div>
            </div>

            <div class="border-t pt-4 mt-4">
                <button id="admin-logout" class="w-full bg-gray-100 text-gray-700 px-3 py-2 rounded text-sm hover:bg-gray-200">
                    <i class="fa fa-sign-out mr-1"></i>é€€å‡ºç™»å½•
                </button>
            </div>
        </div>
    </div>

    <div id="overlay" class="overlay"></div>

    <div id="report-modal" class="modal">
        <h3 class="text-lg font-semibold mb-3">ä¸¾æŠ¥è¯„è®º</h3>
        <p class="text-sm text-gray-600 mb-2">è¯„è®ºå†…å®¹:</p>
        <p class="text-sm bg-gray-100 p-2 rounded mb-3" id="report-comment-content"></p>
        <div class="mb-3">
            <label class="block text-sm font-medium mb-1">ä¸¾æŠ¥åŸå› </label>
            <textarea id="report-reason" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="è¯·è¾“å…¥ä¸¾æŠ¥åŸå› ..."></textarea>
        </div>
        <div class="flex justify-end gap-2">
            <button id="cancel-report" class="px-3 py-1 border rounded text-sm">
                <i class="fa fa-times mr-1"></i>å–æ¶ˆ
            </button>
            <button id="submit-report" class="px-3 py-1 bg-danger text-white rounded text-sm">
                <i class="fa fa-flag mr-1"></i>æäº¤ä¸¾æŠ¥
            </button>
        </div>
    </div>

    <div id="review-report-modal" class="modal">
        <h3 class="text-lg font-semibold mb-3">å®¡æ ¸ä¸¾æŠ¥</h3>
        <p class="text-sm text-gray-600 mb-1">è¢«ä¸¾æŠ¥è¯„è®º:</p>
        <p class="text-sm bg-gray-100 p-2 rounded mb-3" id="review-comment-content"></p>
        <p class="text-sm text-gray-600 mb-1">ä¸¾æŠ¥åŸå› :</p>
        <p class="text-sm bg-gray-100 p-2 rounded mb-1" id="review-report-reason"></p>
        <p class="text-sm text-gray-600 mb-3">ä¸¾æŠ¥ç”¨æˆ·: <span id="review-reporter"></span></p>
        <div class="flex justify-end gap-2">
            <button id="review-no-issue" class="px-3 py-1 border rounded text-sm">
                <i class="fa fa-check mr-1"></i>æ— é—®é¢˜
            </button>
            <button id="review-keep" class="px-3 py-1 bg-warning text-white rounded text-sm">
                <i class="fa fa-eye mr-1"></i>ä¿ç•™è¯„è®º
            </button>
            <button id="review-delete" class="px-3 py-1 bg-danger text-white rounded text-sm">
                <i class="fa fa-trash mr-1"></i>åˆ é™¤è¯„è®º
            </button>
        </div>
    </div>

    <div id="user-modal" class="modal">
        <h3 class="text-lg font-semibold mb-3" id="user-modal-title">ç”¨æˆ·è¯¦æƒ…</h3>
        <div id="user-modal-content"></div>
    </div>

    <div id="login-modal" class="modal">
        <h3 class="text-lg font-semibold mb-3">ç”¨æˆ·ç™»å½•</h3>
        <div class="mb-3">
            <label class="block text-sm font-medium mb-1">å­¦å· (æ ¼å¼: 25+ç­çº§+åºå·)</label>
            <input type="text" id="student-id" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="ä¾‹å¦‚: 251638">
        </div>
        <div class="mb-3">
            <label class="block text-sm font-medium mb-1">çœŸå®å§“å</label>
            <input type="text" id="real-name" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="è¯·è¾“å…¥çœŸå®å§“å">
        </div>
        <div class="mb-3">
            <button id="submit-login" class="w-full bg-primary text-white px-3 py-2 rounded">
                <i class="fa fa-sign-in mr-1"></i>ç™»å½•/æ³¨å†Œ
            </button>
        </div>
        <div class="text-center">
            <button id="admin-login-link" class="text-primary text-sm hover:underline">
                æˆ‘æ˜¯ç®¡ç†å‘˜?
            </button>
        </div>
    </div>

    <div id="admin-login-modal" class="modal">
        <h3 class="text-lg font-semibold mb-3">ç®¡ç†å‘˜ç™»å½•</h3>
        <div class="mb-3">
            <label class="block text-sm font-medium mb-1">ç®¡ç†å‘˜å¯†ç </label>
            <input type="password" id="admin-password" class="w-full px-3 py-2 border border-gray-300 rounded-md">
        </div>
        <div class="mb-3">
            <button id="submit-admin-login" class="w-full bg-primary text-white px-3 py-2 rounded">
                <i class="fa fa-lock mr-1"></i>ç™»å½•
            </button>
        </div>
        <div class="text-center">
            <button id="back-to-user-login" class="text-gray-500 text-sm hover:underline">
                è¿”å›ç”¨æˆ·ç™»å½•
            </button>
        </div>
    </div>

    <div id="username-modal" class="modal">
        <h3 class="text-lg font-semibold mb-3">è®¾ç½®æ˜µç§°</h3>
        <p class="text-sm text-gray-500 mb-3">å¯ä»¥ä¸è¾“å…¥ï¼Œé»˜è®¤ä½¿ç”¨"å­¦å·+çœŸå®å§“å"</p>
        <div class="mb-3">
            <input type="text" id="new-username" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="è®¾ç½®æ‚¨çš„æ˜µç§°">
        </div>
        <div class="mb-4">
            <label class="block text-sm font-medium mb-2">ä¸Šä¼ å¤´åƒ</label>
            <div class="avatar-cropper mb-2">
                <img id="avatar-preview" src="https://img.ixintu.com/download/jpg/20200901/3e9ce3813b7199ea9588eeb920f41208_512_512.jpg!bg" alt="é¢„è§ˆ" class="w-full h-full object-cover">
                <div class="cropper-overlay"></div>
            </div>
            <label class="flex items-center justify-center w-full p-2 border border-dashed border-gray-300 rounded-md cursor-pointer bg-gray-50 hover:bg-gray-100 text-sm">
                <i class="fa fa-upload mr-1"></i> é€‰æ‹©å›¾ç‰‡
                <input type="file" id="avatar-upload-modal" accept="image/*" class="hidden">
            </label>
        </div>
        <div class="flex justify-end">
            <button id="confirm-username" class="px-4 py-2 bg-primary text-white rounded">
                <i class="fa fa-check mr-1"></i>ç¡®è®¤
            </button>
        </div>
    </div>

    <div class="max-w-4xl mx-auto glass-effect rounded-xl p-6 shadow-lg">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-2xl font-bold text-gray-800">è¯„è®ºåŒº</h1>
            <div id="time-widget" class="text-right">
                <!-- æ•°å­—æ—¶é’Ÿ -->
                <div id="digital-clock" class="font-mono font-bold text-primary"></div>
                <!-- æ¨¡æ‹Ÿæ—¶é’Ÿ (é»˜è®¤éšè—) -->
                <div id="analog-clock" class="clock hidden">
                    <div class="clock-hand hour-hand" id="hour-hand"></div>
                    <div class="clock-hand minute-hand" id="minute-hand"></div>
                    <div class="clock-hand second-hand" id="second-hand"></div>
                    <div class="clock-center"></div>
                </div>
                <button id="toggle-clock" class="text-xs text-gray-500 hover:text-primary mt-1">
                    <i class="fa fa-refresh mr-1"></i>åˆ‡æ¢æ—¶é’Ÿæ ·å¼
                </button>
            </div>
        </div>

        <div id="announcement" class="announcement hidden">
            <h3 class="font-semibold flex items-center"><i class="fa fa-bullhorn mr-2"></i>å…¬å‘Š</h3>
            <p id="announcement-text" class="text-sm mt-1"></p>
        </div>

        <div id="banned-users-section" class="mb-6 hidden">
            <h3 class="font-semibold text-danger mb-2 flex items-center"><i class="fa fa-exclamation-triangle mr-2"></i>è¿è§„ç”¨æˆ·å…¬ç¤º</h3>
            <div id="banned-users-list" class="text-sm"></div>
        </div>

        <div class="music-player mb-6">
            <h3 class="font-semibold mb-2 flex items-center"><i class="fa fa-music mr-2"></i>èƒŒæ™¯éŸ³ä¹</h3>
            
            <div class="song-info">
                <div class="song-title" id="song-title">æœªæ’­æ”¾</div>
                <div class="song-artist" id="song-artist">æœªçŸ¥è‰ºæœ¯å®¶</div>
            </div>
            
            <div class="lyrics-container" id="lyrics-container">
                <div class="lyrics-scroll" id="lyrics-scroll">
                    <div class="lyric-line">
                        <div class="lyric-main">è¯·æ’­æ”¾æ­Œæ›²ä»¥æ˜¾ç¤ºæ­Œè¯</div>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center gap-2 mb-2">
                <button id="prev-song" class="p-1 text-gray-600 hover:text-primary"><i class="fa fa-step-backward"></i></button>
                <button id="play-pause" class="p-1 text-gray-600 hover:text-primary"><i class="fa fa-play"></i></button>
                <button id="next-song" class="p-1 text-gray-600 hover:text-primary"><i class="fa fa-step-forward"></i></button>
                <span id="current-song" class="text-sm flex-1 truncate hidden">æœªæ’­æ”¾</span>
            </div>
            
            <div class="w-full bg-gray-200 rounded-full h-1.5 mb-2 cursor-pointer relative" id="progress-container">
                <div id="progress-bar" class="bg-primary h-1.5 rounded-full" style="width: 0%"></div>
                <div id="progress-handle" class="progress-handle" style="left: 0%"></div>
            </div>
            <div class="audio-duration">
                <span id="current-time">00:00</span>
                <span id="total-time">00:00</span>
            </div>
        </div>

        <div class="flex justify-center mb-6">
            <div class="flex items-center border rounded-md overflow-hidden">
                <button id="sort-time" class="px-3 py-1 bg-primary text-white text-sm">
                    <i class="fa fa-clock-o mr-1"></i>æ—¶é—´æ’åº
                </button>
                <button id="sort-likes" class="px-3 py-1 bg-gray-100 text-gray-700 text-sm hover:bg-gray-200">
                    <i class="fa fa-thumbs-up mr-1"></i>ç‚¹èµæ’åº
                </button>
            </div>
        </div>

        <div id="admin-button" class="mb-6 hidden">
            <button id="open-admin-panel" class="bg-primary/90 text-white px-4 py-2 rounded text-sm hover:bg-primary">
                <i class="fa fa-cog mr-1"></i>ç®¡ç†å‘˜é¢æ¿
            </button>
        </div>

        <div class="flex items-center gap-4 mb-6">
            <div class="relative">
                <img id="user-avatar" src="https://img.ixintu.com/download/jpg/20200901/3e9ce3813b7199ea9588eeb920f41208_512_512.jpg!bg" alt="ç”¨æˆ·å¤´åƒ" class="w-12 h-12 rounded-full object-cover border-2 border-primary image-loading" onload="this.classList.remove('image-loading')">
                <label for="avatar-upload" class="absolute bottom-0 right-0 bg-primary text-white rounded-full w-5 h-5 flex items-center justify-center cursor-pointer text-xs">
                    <i class="fa fa-pencil"></i>
                </label>
                <input type="file" id="avatar-upload" accept="image/*" class="hidden">
            </div>
            <div>
                <div class="flex items-center gap-2">
                    <span id="current-username" class="font-semibold"></span>
                    <span id="admin-badge" class="admin-badge hidden">ç®¡ç†å‘˜</span>
                    <button id="change-username" class="text-primary text-sm hover:underline">
                        <i class="fa fa-edit mr-1"></i>ä¿®æ”¹
                    </button>
                    <button id="user-logout" class="text-gray-500 text-sm hover:text-gray-700">
                        <i class="fa fa-sign-out mr-1"></i>é€€å‡º
                    </button>
                </div>
                <div id="posting-restriction" class="text-danger text-xs hidden"></div>
            </div>
        </div>

        <div class="mb-8 bg-neutral/90 rounded-lg p-4">
            <div class="mb-4">
                <label for="comment-content" class="block text-sm font-medium text-gray-700 mb-1">è¯„è®ºå†…å®¹</label>
                <textarea id="comment-content" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50" placeholder="åˆ†äº«ä½ çš„æƒ³æ³•..."></textarea>
                <div id="content-error" class="error-message hidden">è¯·è¾“å…¥è¯„è®ºå†…å®¹</div>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">é™„ä»¶</label>
                <div class="flex gap-3">
                    <div class="flex-1">
                        <label class="flex items-center justify-center w-full p-3 border-2 border-dashed border-gray-300 rounded-md cursor-pointer bg-white/50 hover:bg-white transition-colors">
                            <i class="fa fa-file-image-o mr-2"></i>
                            <span class="text-sm text-gray-500">ä¸Šä¼ å›¾ç‰‡æˆ–æ–‡æ¡£ (â‰¤10MB)</span>
                            <input type="file" id="file-upload" class="hidden" accept="image/*,.pptx,.ppt,.docx,.doc,.txt">
                        </label>
                    </div>
                    <div class="flex-1">
                        <div class="relative">
                            <i class="fa fa-link absolute left-3 top-3 text-gray-400"></i>
                            <input type="text" id="link-upload" class="w-full pl-9 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50" placeholder="æˆ–è¾“å…¥é“¾æ¥">
                        </div>
                    </div>
                </div>
                <div id="file-preview" class="mt-2 hidden"></div>
                <div id="file-error" class="error-message hidden"></div>
            </div>
            
            <button id="submit-comment" class="bg-primary text-white px-4 py-2 rounded-md hover:bg-primary/90 transition-colors">
                <i class="fa fa-paper-plane mr-1"></i>å‘å¸ƒè¯„è®º
            </button>
            <span id="posting-status" class="ml-2 text-sm text-red-500 hidden"></span>
        </div>
        
        <div id="comments-container" class="space-y-6">
            <div class="text-center text-gray-500 py-8" id="empty-state">
                <span class="text-4xl mb-2 opacity-30">ğŸ’¬</span>
                <p>è¿˜æ²¡æœ‰è¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘å§~</p>
            </div>
        </div>
        
        <div id="pagination" class="flex justify-center mt-8 gap-2 hidden">
            <button id="prev-page" class="px-3 py-1 border rounded-md hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fa fa-chevron-left mr-1"></i>ä¸Šä¸€é¡µ
            </button>
            <span id="page-info" class="px-3 py-1"></span>
            <button id="next-page" class="px-3 py-1 border rounded-md hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">
                ä¸‹ä¸€é¡µ<i class="fa fa-chevron-right ml-1"></i>
            </button>
        </div>
    </div>

    <script>
        const DEFAULT_AVATAR = 'https://img.ixintu.com/download/jpg/20200901/3e9ce3813b7199ea9588eeb920f41208_512_512.jpg!bg';
        const MAX_COMMENTS = 100;
        const MAX_FILE_SIZE = 10 * 1024 * 1024;
        const MAX_IMAGE_SIZE = 200 * 1024;
        const IMAGE_QUALITY = 0.7;
        const PAGE_SIZE = 7;
        const MAX_REPLIES_BEFORE_COLLAPSE = 5;
        const ADMIN_PASSWORD = 'admin123';
        
        // æ­Œæ›²åˆ—è¡¨
        const SONGS = [
            { 
                id: 501468000, 
                name: "Sacred Play Secret Place", 
                artist: "Matryoshka",
                url: "https://music.163.com/song/media/outer/url?id=501468000.mp3",
                lyricUrl: "https://api.allorigins.win/get?url=" + encodeURIComponent("https://music.163.com/api/song/lyric?id=501468000&lv=1&kv=1&tv=-1")
            },
            { 
                id: 786262, 
                name: "You", 
                artist: "M.graveyard",
                url: "https://music.163.com/song/media/outer/url?id=786262.mp3",
                lyricUrl: "https://api.allorigins.win/get?url=" + encodeURIComponent("https://music.163.com/api/song/lyric?id=786262&lv=1&kv=1&tv=-1")
            },
            { 
                id: 1996821601, 
                name: "æµæ˜Ÿã®ãƒ‘ãƒ«ã‚¹(æµæ˜Ÿçš„è„‰æ)", 
                artist: "*Luna",
                url: "https://music.163.com/song/media/outer/url?id=1996821601.mp3",
                lyricUrl: "https://api.allorigins.win/get?url=" + encodeURIComponent("https://music.163.com/api/song/lyric?id=1996821601&lv=1&kv=1&tv=-1")
            },
            { 
                id: 1996825230, 
                name: "ãƒ•ãƒ­ãƒ ãƒˆãƒ¼ã‚­ãƒ§ãƒ¼(From Tokyo)", 
                artist: "å¤ä»£å­æ˜",
                url: "https://music.163.com/song/media/outer/url?id=1996825230.mp3",
                lyricUrl: "https://api.allorigins.win/get?url=" + encodeURIComponent("https://music.163.com/api/song/lyric?id=1996825230&lv=1&kv=1&tv=-1")
            },
            { 
                id: 427016439, 
                name: "å¿ƒåŠ å¿ƒ", 
                artist: "é˜¿è‰¯è‰¯æœ¨å¥",
                url: "https://music.163.com/song/media/outer/url?id=427016439.mp3",
                lyricUrl: "https://api.allorigins.win/get?url=" + encodeURIComponent("https://music.163.com/api/song/lyric?id=427016439&lv=1&kv=1&tv=-1")
            }
        ];
        
        let currentSongIndex = 0;
        let isPlaying = false;
        let audio = new Audio();
        let currentLyrics = [];
        let currentPage = 1;
        let sortBy = 'time';
        let currentUser = null;
        let isClockDigital = true; // è·Ÿè¸ªå½“å‰æ—¶é’Ÿæ ·å¼ï¼Œtrueä¸ºæ•°å­—æ—¶é’Ÿï¼Œfalseä¸ºæ¨¡æ‹Ÿæ—¶é’Ÿ
        let loginTimeout = null;
        let isDragging = false; // è·Ÿè¸ªæ˜¯å¦æ­£åœ¨æ‹–åŠ¨è¿›åº¦æ¡
        let userIsScrolling = false; // è·Ÿè¸ªç”¨æˆ·æ˜¯å¦æ­£åœ¨æ‰‹åŠ¨æ»šåŠ¨æ­Œè¯
        let scrollTimeout = null; // ç”¨äºå»¶è¿Ÿæ¢å¤è‡ªåŠ¨æ»šåŠ¨

        function initApp() {
            simulateLoading();
            initLocalStorage();
            setupEventListeners();
            startClock();
            initAudioPlayer();
            checkLoginStatus();
        }

        function initAudioPlayer() {
            audio.addEventListener('timeupdate', updateProgress);
            audio.addEventListener('ended', playNextSong);
            audio.addEventListener('loadedmetadata', updateAudioDuration);
            
            const progressContainer = document.getElementById('progress-container');
            const progressHandle = document.getElementById('progress-handle');
            
            // è¿›åº¦æ¡ç‚¹å‡»äº‹ä»¶
            progressContainer.addEventListener('click', function(e) {
                updateProgressFromMouseEvent(e);
            });
            
            // è¿›åº¦æ¡æ‹–åŠ¨å¼€å§‹ï¼ˆé¼ æ ‡æŒ‰ä¸‹ï¼‰
            progressHandle.addEventListener('mousedown', function(e) {
                isDragging = true;
                progressHandle.classList.add('scale-125');
                document.body.style.cursor = 'grabbing';
                e.preventDefault(); // é˜²æ­¢æ‹–åŠ¨æ—¶é€‰ä¸­æ–‡æœ¬
            });
            
            // é¼ æ ‡ç§»åŠ¨ï¼ˆæ‹–åŠ¨è¿‡ç¨‹ï¼‰
            document.addEventListener('mousemove', function(e) {
                if (isDragging) {
                    updateProgressFromMouseEvent(e);
                    e.preventDefault(); // é˜²æ­¢æ‹–åŠ¨æ—¶é¡µé¢æ»šåŠ¨
                }
            });
            
            // æ‹–åŠ¨ç»“æŸï¼ˆé¼ æ ‡é‡Šæ”¾ï¼‰
            document.addEventListener('mouseup', function() {
                if (isDragging) {
                    isDragging = false;
                    progressHandle.classList.remove('scale-125');
                    document.body.style.cursor = '';
                    
                    // è®¾ç½®éŸ³é¢‘ä½ç½®
                    const progress = parseFloat(document.getElementById('progress-bar').style.width);
                    if (!isNaN(audio.duration)) {
                        audio.currentTime = (progress / 100) * audio.duration;
                    }
                }
            });
            
            // æ­Œè¯ç‚¹å‡»äº‹ä»¶
            document.getElementById('lyrics-scroll').addEventListener('click', function(e) {
                const lyricLine = e.target.closest('.lyric-line');
                if (lyricLine) {
                    const index = Array.from(this.children).indexOf(lyricLine);
                    if (index >= 0 && currentLyrics[index]) {
                        // ç”¨æˆ·ç‚¹å‡»æ­Œè¯è¡Œæ—¶ï¼Œè·³è½¬åˆ°å¯¹åº”æ—¶é—´ç‚¹
                        audio.currentTime = currentLyrics[index].time;
                        updateProgress();
                        // æš‚æ—¶ç¦ç”¨ç”¨æˆ·æ»šåŠ¨æ ‡è®°ï¼Œè®©è‡ªåŠ¨æ»šåŠ¨ç”Ÿæ•ˆ
                        userIsScrolling = false;
                        if (scrollTimeout) clearTimeout(scrollTimeout);
                    }
                }
            });
            
            // æ­Œè¯å®¹å™¨æ»šåŠ¨äº‹ä»¶ - æ£€æµ‹ç”¨æˆ·æ‰‹åŠ¨æ»šåŠ¨
            const lyricsContainer = document.getElementById('lyrics-container');
            lyricsContainer.addEventListener('scroll', function() {
                // ç”¨æˆ·å¼€å§‹æ»šåŠ¨æ—¶è®¾ç½®æ ‡è®°
                userIsScrolling = true;
                
                // æ¸…é™¤ä¹‹å‰çš„è¶…æ—¶
                if (scrollTimeout) clearTimeout(scrollTimeout);
                
                // 5ç§’åæ¢å¤è‡ªåŠ¨æ»šåŠ¨
                scrollTimeout = setTimeout(() => {
                    userIsScrolling = false;
                }, 5000);
            });
        }
        
        // æ ¹æ®é¼ æ ‡äº‹ä»¶æ›´æ–°è¿›åº¦
        function updateProgressFromMouseEvent(e) {
            const progressContainer = document.getElementById('progress-container');
            const rect = progressContainer.getBoundingClientRect();
            
            // è®¡ç®—é¼ æ ‡åœ¨è¿›åº¦æ¡ä¸Šçš„ç›¸å¯¹ä½ç½®ï¼ˆ0-100%ï¼‰
            let pos = (e.clientX - rect.left) / rect.width;
            pos = Math.max(0, Math.min(1, pos)); // é™åˆ¶åœ¨0-1ä¹‹é—´
            
            // æ›´æ–°è¿›åº¦æ¡å’Œæ‰‹æŸ„ä½ç½®
            const percentage = pos * 100;
            document.getElementById('progress-bar').style.width = `${percentage}%`;
            document.getElementById('progress-handle').style.left = `${percentage}%`;
            
            // æ›´æ–°å½“å‰æ—¶é—´æ˜¾ç¤º
            if (!isNaN(audio.duration)) {
                const currentTime = pos * audio.duration;
                document.getElementById('current-time').textContent = formatTime(currentTime);
            }
        }

        function updateAudioDuration() {
            const totalTimeEl = document.getElementById('total-time');
            totalTimeEl.textContent = formatTime(audio.duration);
        }

        function formatTime(seconds) {
            if (isNaN(seconds)) return "00:00";
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function updateProgress() {
            // å¦‚æœæ­£åœ¨æ‹–åŠ¨ï¼Œä¸æ›´æ–°è¿›åº¦ï¼ˆé¿å…ä¸ç”¨æˆ·æ“ä½œå†²çªï¼‰
            if (isDragging) return;
            
            const progress = (audio.currentTime / audio.duration) * 100;
            document.getElementById('progress-bar').style.width = `${progress}%`;
            document.getElementById('progress-handle').style.left = `${progress}%`;
            document.getElementById('current-time').textContent = formatTime(audio.currentTime);
            updateLyrics();
        }

        function updateLyrics() {
            if (currentLyrics.length === 0) return;
            
            // å¦‚æœç”¨æˆ·æ­£åœ¨æ‰‹åŠ¨æ»šåŠ¨æ­Œè¯ï¼Œåˆ™ä¸è‡ªåŠ¨å®šä½
            if (userIsScrolling) return;
            
            const currentTime = audio.currentTime;
            const lyricsScroll = document.getElementById('lyrics-scroll');
            const lyricsContainer = document.getElementById('lyrics-container');
            let activeIndex = -1;
            
            for (let i = 0; i < currentLyrics.length; i++) {
                if (currentLyrics[i].time <= currentTime) {
                    activeIndex = i;
                } else {
                    break;
                }
            }
            
            if (activeIndex !== -1) {
                // æ›´æ–°æ´»è·ƒæ­Œè¯æ ·å¼
                document.querySelectorAll('.lyric-line').forEach((line, index) => {
                    line.classList.toggle('active', index === activeIndex);
                });
                
                // è®¡ç®—éœ€è¦æ»šåŠ¨çš„ä½ç½®ï¼Œä½¿å½“å‰æ­Œè¯å±…ä¸­
                const activeLine = lyricsScroll.children[activeIndex];
                if (activeLine) {
                    const containerHeight = lyricsContainer.clientHeight;
                    const lineTop = activeLine.offsetTop;
                    const lineHeight = activeLine.offsetHeight;
                    
                    // è®¡ç®—æ»šåŠ¨ä½ç½®ï¼Œä½¿å½“å‰æ­Œè¯å±…ä¸­
                    const scrollPosition = lineTop - (containerHeight / 2) + (lineHeight / 2);
                    
                    // å¹³æ»‘æ»šåŠ¨åˆ°ç›®æ ‡ä½ç½®
                    lyricsContainer.scrollTo({
                        top: scrollPosition,
                        behavior: 'smooth'
                    });
                }
            }
        }

        // è§£æå¸¦ç¿»è¯‘çš„æ­Œè¯
        function parseLyricsWithTranslation(lrcContent, translationContent) {
            const lyrics = [];
            const translationMap = {};
            const timeRegex = /\[(\d{2}):(\d{2}\.\d{2,3})\]/;
            
            // å…ˆè§£æç¿»è¯‘å†…å®¹
            if (translationContent) {
                const transLines = translationContent.split('\n');
                transLines.forEach(line => {
                    const match = line.match(timeRegex);
                    if (match) {
                        const minutes = parseInt(match[1]);
                        const seconds = parseFloat(match[2]);
                        const time = minutes * 60 + seconds;
                        const text = line.replace(timeRegex, '').trim();
                        translationMap[time.toFixed(2)] = text;
                    }
                });
            }
            
            // è§£æä¸»æ­Œè¯å¹¶åŒ¹é…ç¿»è¯‘
            const lrcLines = lrcContent.split('\n');
            lrcLines.forEach(line => {
                const match = line.match(timeRegex);
                if (match) {
                    const minutes = parseInt(match[1]);
                    const seconds = parseFloat(match[2]);
                    const time = minutes * 60 + seconds;
                    const text = line.replace(timeRegex, '').trim();
                    
                    if (text) {
                        // æŸ¥æ‰¾å¯¹åº”çš„ç¿»è¯‘
                        const translation = translationMap[time.toFixed(2)] || '';
                        lyrics.push({ 
                            time, 
                            text,
                            translation 
                        });
                    }
                }
            });
            
            return lyrics.sort((a, b) => a.time - b.time);
        }

        // åŠ è½½å¸¦ç¿»è¯‘çš„æ­Œè¯
        async function loadLyrics(lyricUrl) {
            try {
                const response = await fetch(lyricUrl);
                if (!response.ok) throw new Error('æ— æ³•è·å–æ­Œè¯');
                
                const data = await response.json();
                const lyricsContainer = document.getElementById('lyrics-scroll');
                
                lyricsContainer.innerHTML = '';
                currentLyrics = [];
                
                // è§£æä»£ç†è¿”å›çš„å†…å®¹
                const content = JSON.parse(data.contents);
                
                // è·å–ä¸»æ­Œè¯å’Œç¿»è¯‘æ­Œè¯
                const lrcContent = content.lrc?.lyric || '';
                const translationContent = content.tlyric?.lyric || '';
                
                if (lrcContent) {
                    // è§£æå¸¦ç¿»è¯‘çš„æ­Œè¯
                    currentLyrics = parseLyricsWithTranslation(lrcContent, translationContent);
                    
                    currentLyrics.forEach(lyric => {
                        const div = document.createElement('div');
                        div.className = 'lyric-line';
                        
                        // ä¸»æ­Œè¯
                        const mainText = document.createElement('div');
                        mainText.className = 'lyric-main';
                        mainText.textContent = lyric.text;
                        div.appendChild(mainText);
                        
                        // ç¿»è¯‘ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
                        if (lyric.translation) {
                            const transText = document.createElement('div');
                            transText.className = 'lyric-translation';
                            transText.textContent = lyric.translation;
                            div.appendChild(transText);
                        }
                        
                        lyricsContainer.appendChild(div);
                    });
                } else {
                    const div = document.createElement('div');
                    div.className = 'lyric-line';
                    div.innerHTML = '<div class="lyric-main">æš‚æ— æ­Œè¯</div>';
                    lyricsContainer.appendChild(div);
                }
            } catch (error) {
                console.error('åŠ è½½æ­Œè¯å¤±è´¥:', error);
                const lyricsContainer = document.getElementById('lyrics-scroll');
                lyricsContainer.innerHTML = '<div class="lyric-line"><div class="lyric-main">æ— æ³•åŠ è½½æ­Œè¯</div></div>';
            }
        }

        function loadCurrentSong() {
            const song = SONGS[currentSongIndex];
            document.getElementById('song-title').textContent = song.name;
            document.getElementById('song-artist').textContent = song.artist;
            document.getElementById('current-song').textContent = song.name;
            audio.src = song.url;
            loadLyrics(song.lyricUrl);
        }

        function togglePlayPause() {
            if (isPlaying) {
                audio.pause();
                document.getElementById('play-pause').innerHTML = '<i class="fa fa-play"></i>';
            } else {
                if (audio.src === '') {
                    loadCurrentSong();
                }
                audio.play();
                document.getElementById('play-pause').innerHTML = '<i class="fa fa-pause"></i>';
            }
            isPlaying = !isPlaying;
        }

        function playPrevSong() {
            currentSongIndex = (currentSongIndex - 1 + SONGS.length) % SONGS.length;
            loadCurrentSong();
            if (!isPlaying) {
                togglePlayPause();
            } else {
                audio.play();
            }
        }

        function playNextSong() {
            currentSongIndex = (currentSongIndex + 1) % SONGS.length;
            loadCurrentSong();
            if (!isPlaying) {
                togglePlayPause();
            } else {
                audio.play();
            }
        }

        function initLocalStorage() {
            // æ£€æŸ¥å¹¶åˆå§‹åŒ–localStorageé¡¹ï¼Œç¡®ä¿å®ƒä»¬æ˜¯æœ‰æ•ˆçš„JSON
            try {
                if (!localStorage.getItem('users')) localStorage.setItem('users', JSON.stringify({}));
                else JSON.parse(localStorage.getItem('users')); // éªŒè¯æ ¼å¼
                
                if (!localStorage.getItem('comments')) localStorage.setItem('comments', JSON.stringify([]));
                else JSON.parse(localStorage.getItem('comments')); // éªŒè¯æ ¼å¼
                
                if (!localStorage.getItem('reports')) localStorage.setItem('reports', JSON.stringify([]));
                else JSON.parse(localStorage.getItem('reports')); // éªŒè¯æ ¼å¼
                
                if (!localStorage.getItem('announcement')) localStorage.setItem('announcement', '');
                
                if (!localStorage.getItem('bannedUsers')) localStorage.setItem('bannedUsers', JSON.stringify([]));
                else JSON.parse(localStorage.getItem('bannedUsers')); // éªŒè¯æ ¼å¼
                
                // æ£€æŸ¥currentUseræ˜¯å¦å­˜åœ¨ä¸”æ ¼å¼æ­£ç¡®
                const currentUser = localStorage.getItem('currentUser');
                if (currentUser) {
                    JSON.parse(currentUser); // éªŒè¯æ ¼å¼
                }
            } catch (error) {
                console.error('localStorageæ•°æ®æ ¼å¼é”™è¯¯ï¼Œå·²é‡ç½®:', error);
                // é‡ç½®æŸåçš„localStorageé¡¹
                if (error.message.includes('users')) localStorage.setItem('users', JSON.stringify({}));
                if (error.message.includes('comments')) localStorage.setItem('comments', JSON.stringify([]));
                if (error.message.includes('reports')) localStorage.setItem('reports', JSON.stringify([]));
                if (error.message.includes('bannedUsers')) localStorage.setItem('bannedUsers', JSON.stringify([]));
                if (error.message.includes('currentUser')) localStorage.removeItem('currentUser');
            }
        }

        function setupEventListeners() {
            // éŸ³ä¹æ§åˆ¶æŒ‰é’®
            document.getElementById('play-pause').addEventListener('click', togglePlayPause);
            document.getElementById('prev-song').addEventListener('click', playPrevSong);
            document.getElementById('next-song').addEventListener('click', playNextSong);
            
            // ç™»å½•ç›¸å…³
            document.getElementById('submit-login').addEventListener('click', handleLogin);
            document.getElementById('admin-login-link').addEventListener('click', showAdminLogin);
            document.getElementById('back-to-user-login').addEventListener('click', showUserLogin);
            document.getElementById('submit-admin-login').addEventListener('click', handleAdminLogin);
            document.getElementById('user-logout').addEventListener('click', handleLogout);
            document.getElementById('admin-logout').addEventListener('click', handleAdminLogout);
            document.getElementById('change-username').addEventListener('click', showUsernameModal);
            document.getElementById('confirm-username').addEventListener('click', confirmUsername);
            
            // è¯„è®ºç›¸å…³
            document.getElementById('submit-comment').addEventListener('click', submitComment);
            document.getElementById('sort-time').addEventListener('click', () => sortComments('time'));
            document.getElementById('sort-likes').addEventListener('click', () => sortComments('likes'));
            document.getElementById('prev-page').addEventListener('click', () => changePage(-1));
            document.getElementById('next-page').addEventListener('click', () => changePage(1));
            
            // ç®¡ç†å‘˜é¢æ¿
            document.getElementById('open-admin-panel').addEventListener('click', openAdminPanel);
            document.getElementById('close-admin-panel').addEventListener('click', closeAdminPanel);
            document.getElementById('overlay').addEventListener('click', closeAdminPanel);
            document.getElementById('save-announcement').addEventListener('click', saveAnnouncement);
            document.getElementById('delete-announcement').addEventListener('click', deleteAnnouncement);
            
            // ä¸¾æŠ¥ç›¸å…³
            document.getElementById('cancel-report').addEventListener('click', closeReportModal);
            document.getElementById('submit-report').addEventListener('click', submitReport);
            document.getElementById('review-no-issue').addEventListener('click', () => handleReportReview('no-issue'));
            document.getElementById('review-keep').addEventListener('click', () => handleReportReview('keep'));
            document.getElementById('review-delete').addEventListener('click', () => handleReportReview('delete'));
            
            // å¤´åƒä¸Šä¼ 
            document.getElementById('avatar-upload').addEventListener('change', handleAvatarUpload);
            document.getElementById('avatar-upload-modal').addEventListener('change', handleAvatarUploadModal);
            
            // å›¾ç‰‡æŸ¥çœ‹å™¨
            document.getElementById('close-image-viewer').addEventListener('click', closeImageViewer);
            document.getElementById('image-viewer').addEventListener('click', (e) => {
                if (e.target === document.getElementById('image-viewer')) {
                    closeImageViewer();
                }
            });
            
            // æ–‡ä»¶ä¸Šä¼ é¢„è§ˆ
            document.getElementById('file-upload').addEventListener('change', handleFileUpload);
            
            // æ—¶é’Ÿæ ·å¼åˆ‡æ¢
            document.getElementById('toggle-clock').addEventListener('click', toggleClockStyle);
        }

        // åˆ‡æ¢æ—¶é’Ÿæ ·å¼
        function toggleClockStyle() {
            isClockDigital = !isClockDigital;
            const digitalClock = document.getElementById('digital-clock');
            const analogClock = document.getElementById('analog-clock');
            
            if (isClockDigital) {
                // æ˜¾ç¤ºæ•°å­—æ—¶é’Ÿï¼Œéšè—æ¨¡æ‹Ÿæ—¶é’Ÿ
                digitalClock.classList.remove('hidden');
                analogClock.classList.add('hidden');
            } else {
                // æ˜¾ç¤ºæ¨¡æ‹Ÿæ—¶é’Ÿï¼Œéšè—æ•°å­—æ—¶é’Ÿ
                digitalClock.classList.add('hidden');
                analogClock.classList.remove('hidden');
                // æ›´æ–°æ¨¡æ‹Ÿæ—¶é’ŸæŒ‡é’ˆä½ç½®
                updateAnalogClock();
            }
        }

        function startClock() {
            updateClock();
            setInterval(updateClock, 1000);
        }

        function updateClock() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            
            // æ›´æ–°æ•°å­—æ—¶é’Ÿ
            document.getElementById('digital-clock').textContent = `${hours}:${minutes}:${seconds}`;
            
            // å¦‚æœå½“å‰æ˜¾ç¤ºçš„æ˜¯æ¨¡æ‹Ÿæ—¶é’Ÿï¼Œæ›´æ–°æŒ‡é’ˆä½ç½®
            if (!isClockDigital) {
                updateAnalogClock();
            }
        }

        // æ›´æ–°æ¨¡æ‹Ÿæ—¶é’ŸæŒ‡é’ˆä½ç½®
        function updateAnalogClock() {
            const now = new Date();
            const hours = now.getHours() % 12; // è½¬ä¸º12å°æ—¶åˆ¶
            const minutes = now.getMinutes();
            const seconds = now.getSeconds();
            
            // è®¡ç®—å„æŒ‡é’ˆçš„è§’åº¦ï¼ˆç§’é’ˆ6åº¦/ç§’ï¼Œåˆ†é’ˆ6åº¦/åˆ†ï¼Œæ—¶é’ˆ30åº¦/å°æ—¶+0.5åº¦/åˆ†ï¼‰
            const secondDeg = seconds * 6;
            const minuteDeg = minutes * 6 + seconds * 0.1;
            const hourDeg = hours * 30 + minutes * 0.5;
            
            // åº”ç”¨æ—‹è½¬
            document.getElementById('second-hand').style.transform = `rotate(${secondDeg}deg)`;
            document.getElementById('minute-hand').style.transform = `rotate(${minuteDeg}deg)`;
            document.getElementById('hour-hand').style.transform = `rotate(${hourDeg}deg)`;
        }

        function simulateLoading() {
            const loadingScreen = document.getElementById('loading-screen');
            const estimatedTimeEl = document.getElementById('estimated-time');
            let seconds = 0;
            
            const interval = setInterval(() => {
                seconds++;
                estimatedTimeEl.textContent = (seconds / 60).toFixed(1);
                
                // æ¨¡æ‹Ÿ2-4ç§’ååŠ è½½å®Œæˆ
                if (seconds > 2 + Math.random() * 2) {
                    clearInterval(interval);
                    loadingScreen.style.opacity = '0';
                    setTimeout(() => {
                        loadingScreen.style.display = 'none';
                    }, 500);
                }
            }, 1000);
        }

        function checkLoginStatus() {
            try {
                const savedUser = localStorage.getItem('currentUser');
                if (savedUser) {
                    // å°è¯•è§£æç”¨æˆ·æ•°æ®ï¼Œå¦‚æœå¤±è´¥åˆ™æ¸…é™¤
                    currentUser = JSON.parse(savedUser);
                    updateUserInterface();
                    loadComments();
                    loadAnnouncement();
                    loadBannedUsers();
                } else {
                    showLoginModal();
                }
            } catch (error) {
                console.error('è§£æç”¨æˆ·æ•°æ®å¤±è´¥ï¼Œå·²æ¸…é™¤æ— æ•ˆæ•°æ®:', error);
                localStorage.removeItem('currentUser');
                currentUser = null;
                showLoginModal();
            }
        }

        function showLoginModal() {
            document.getElementById('login-modal').classList.add('show');
            document.getElementById('overlay').classList.add('show');
        }

        function hideLoginModal() {
            document.getElementById('login-modal').classList.remove('show');
            document.getElementById('admin-login-modal').classList.remove('show');
            document.getElementById('overlay').classList.remove('show');
        }

        function showAdminLogin() {
            document.getElementById('login-modal').classList.remove('show');
            document.getElementById('admin-login-modal').classList.add('show');
        }

        function showUserLogin() {
            document.getElementById('admin-login-modal').classList.remove('show');
            document.getElementById('login-modal').classList.add('show');
        }

        function handleLogin() {
            const studentId = document.getElementById('student-id').value.trim();
            const realName = document.getElementById('real-name').value.trim();
            
            if (!studentId || !realName) {
                alert('è¯·è¾“å…¥å­¦å·å’Œå§“å');
                return;
            }
            
            const users = JSON.parse(localStorage.getItem('users'));
            let user = users[studentId];
            
            if (!user) {
                user = {
                    id: studentId,
                    name: realName,
                    username: `${studentId}-${realName}`,
                    avatar: DEFAULT_AVATAR,
                    isAdmin: false,
                    joinDate: new Date().toISOString()
                };
                users[studentId] = user;
                localStorage.setItem('users', JSON.stringify(users));
            }
            
            currentUser = user;
            localStorage.setItem('currentUser', JSON.stringify(user));
            
            if (!user.username || user.username === `${studentId}-${realName}`) {
                document.getElementById('new-username').value = '';
                document.getElementById('avatar-preview').src = user.avatar || DEFAULT_AVATAR;
                document.getElementById('username-modal').classList.add('show');
                document.getElementById('overlay').classList.add('show');
            } else {
                hideLoginModal();
                updateUserInterface();
                loadComments();
                loadAnnouncement();
                loadBannedUsers();
            }
        }

        function handleAdminLogin() {
            const password = document.getElementById('admin-password').value;
            
            if (password === ADMIN_PASSWORD) {
                const adminId = 'admin';
                const users = JSON.parse(localStorage.getItem('users'));
                let admin = users[adminId];
                
                if (!admin) {
                    admin = {
                        id: adminId,
                        name: 'ç®¡ç†å‘˜',
                        username: 'ç®¡ç†å‘˜',
                        avatar: DEFAULT_AVATAR,
                        isAdmin: true,
                        joinDate: new Date().toISOString()
                    };
                    users[adminId] = admin;
                    localStorage.setItem('users', JSON.stringify(users));
                }
                
                currentUser = admin;
                localStorage.setItem('currentUser', JSON.stringify(admin));
                
                hideLoginModal();
                updateUserInterface();
                loadComments();
                loadAnnouncement();
                loadBannedUsers();
                loadAdminPanelData();
            } else {
                alert('å¯†ç é”™è¯¯');
            }
        }

        function handleLogout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                localStorage.removeItem('currentUser');
                currentUser = null;
                showLoginModal();
            }
        }

        function handleAdminLogout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç®¡ç†å‘˜ç™»å½•å—ï¼Ÿ')) {
                localStorage.removeItem('currentUser');
                currentUser = null;
                closeAdminPanel();
                showLoginModal();
            }
        }

        function showUsernameModal() {
            const user = currentUser;
            document.getElementById('new-username').value = user.username || '';
            document.getElementById('avatar-preview').src = user.avatar || DEFAULT_AVATAR;
            document.getElementById('username-modal').classList.add('show');
            document.getElementById('overlay').classList.add('show');
        }

        function confirmUsername() {
            const newUsername = document.getElementById('new-username').value.trim();
            const user = currentUser;
            
            if (newUsername) {
                user.username = newUsername;
            }
            
            const users = JSON.parse(localStorage.getItem('users'));
            users[user.id] = user;
            localStorage.setItem('users', JSON.stringify(users));
            localStorage.setItem('currentUser', JSON.stringify(user));
            
            document.getElementById('username-modal').classList.remove('show');
            document.getElementById('overlay').classList.remove('show');
            
            updateUserInterface();
            loadComments();
        }

        function updateUserInterface() {
            if (!currentUser) return;
            
            document.getElementById('current-username').textContent = currentUser.username;
            document.getElementById('user-avatar').src = currentUser.avatar || DEFAULT_AVATAR;
            
            if (currentUser.isAdmin) {
                document.getElementById('admin-badge').classList.remove('hidden');
                document.getElementById('admin-button').classList.remove('hidden');
            } else {
                document.getElementById('admin-badge').classList.add('hidden');
                document.getElementById('admin-button').classList.add('hidden');
            }
            
            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦è¢«ç¦è¨€
            const bannedUsers = JSON.parse(localStorage.getItem('bannedUsers'));
            const isBanned = bannedUsers.some(u => u.id === currentUser.id);
            
            if (isBanned) {
                document.getElementById('posting-restriction').textContent = 'æ‚¨å·²è¢«ç¦è¨€ï¼Œæ— æ³•å‘å¸ƒè¯„è®º';
                document.getElementById('posting-restriction').classList.remove('hidden');
                document.getElementById('submit-comment').disabled = true;
                document.getElementById('submit-comment').classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                document.getElementById('posting-restriction').classList.add('hidden');
                document.getElementById('submit-comment').disabled = false;
                document.getElementById('submit-comment').classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        function submitComment() {
            const content = document.getElementById('comment-content').value.trim();
            const link = document.getElementById('link-upload').value.trim();
            
            if (!content) {
                document.getElementById('content-error').classList.remove('hidden');
                return;
            }
            
            document.getElementById('content-error').classList.add('hidden');
            
            const comments = JSON.parse(localStorage.getItem('comments'));
            const newComment = {
                id: Date.now().toString(),
                userId: currentUser.id,
                username: currentUser.username,
                avatar: currentUser.avatar || DEFAULT_AVATAR,
                content: content,
                link: link,
                timestamp: new Date().toISOString(),
                likes: 0,
                likedBy: [],
                replies: []
            };
            
            // æ·»åŠ æ–‡ä»¶ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
            const filePreview = document.getElementById('file-preview');
            if (filePreview.classList.contains('show')) {
                newComment.file = {
                    name: filePreview.dataset.filename,
                    url: filePreview.dataset.fileurl,
                    type: filePreview.dataset.filetype
                };
            }
            
            comments.unshift(newComment);
            if (comments.length > MAX_COMMENTS) {
                comments.pop();
            }
            
            localStorage.setItem('comments', JSON.stringify(comments));
            document.getElementById('comment-content').value = '';
            document.getElementById('link-upload').value = '';
            document.getElementById('file-upload').value = '';
            filePreview.classList.add('hidden');
            
            loadComments();
        }

        function loadComments() {
            const comments = JSON.parse(localStorage.getItem('comments'));
            const container = document.getElementById('comments-container');
            const emptyState = document.getElementById('empty-state');
            const pagination = document.getElementById('pagination');
            const pageInfo = document.getElementById('page-info');
            
            if (comments.length === 0) {
                emptyState.classList.remove('hidden');
                pagination.classList.add('hidden');
                container.innerHTML = '';
                return;
            }
            
            emptyState.classList.add('hidden');
            
            // æ’åºè¯„è®º
            let sortedComments = [...comments];
            if (sortBy === 'time') {
                sortedComments.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            } else if (sortBy === 'likes') {
                sortedComments.sort((a, b) => b.likes - a.likes);
            }
            
            // åˆ†é¡µ
            const totalPages = Math.ceil(sortedComments.length / PAGE_SIZE);
            currentPage = Math.max(1, Math.min(currentPage, totalPages));
            const startIndex = (currentPage - 1) * PAGE_SIZE;
            const paginatedComments = sortedComments.slice(startIndex, startIndex + PAGE_SIZE);
            
            // æ›´æ–°åˆ†é¡µä¿¡æ¯
            pageInfo.textContent = `ç¬¬ ${currentPage} é¡µ / å…± ${totalPages} é¡µ`;
            document.getElementById('prev-page').disabled = currentPage === 1;
            document.getElementById('next-page').disabled = currentPage === totalPages;
            pagination.classList.remove('hidden');
            
            // æ¸²æŸ“è¯„è®º
            container.innerHTML = '';
            paginatedComments.forEach(comment => {
                container.appendChild(createCommentElement(comment));
            });
        }

        function createCommentElement(comment) {
            const div = document.createElement('div');
            div.className = 'comment-shadow bg-white rounded-lg p-4';
            div.dataset.id = comment.id;
            
            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦è¢«ç¦è¨€
            const bannedUsers = JSON.parse(localStorage.getItem('bannedUsers'));
            const isBanned = bannedUsers.some(u => u.id === comment.userId);
            
            let fileHtml = '';
            if (comment.file) {
                if (comment.file.type.startsWith('image/')) {
                    fileHtml = `<div class="mt-2">
                        <img src="${comment.file.url}" alt="${comment.file.name}" class="max-w-full max-h-60 rounded cursor-pointer comment-image">
                        <p class="text-xs text-gray-500 mt-1">${comment.file.name}</p>
                    </div>`;
                } else {
                    fileHtml = `<div class="mt-2 flex items-center text-sm text-primary">
                        <i class="fa fa-file-o mr-1"></i>
                        <a href="${comment.file.url}" target="_blank">${comment.file.name}</a>
                    </div>`;
                }
            }
            
            let linkHtml = '';
            if (comment.link) {
                const linkText = comment.link.length > 30 ? comment.link.substring(0, 30) + '...' : comment.link;
                linkHtml = `<div class="mt-2 flex items-center text-sm text-primary">
                    <i class="fa fa-link mr-1"></i>
                    <a href="${comment.link}" target="_blank">${linkText}</a>
                </div>`;
            }
            
            const isLiked = comment.likedBy.includes(currentUser.id);
            const likeIcon = isLiked ? 'fa-thumbs-up' : 'fa-thumbs-o-up';
            const likeClass = isLiked ? 'text-primary' : 'text-gray-500';
            
            const date = new Date(comment.timestamp);
            const formattedDate = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
            
            div.innerHTML = `
                <div class="flex items-start gap-3">
                    <img src="${comment.avatar}" alt="${comment.username}" class="w-10 h-10 rounded-full object-cover">
                    <div class="flex-1">
                        <div class="flex items-center justify-between">
                            <div>
                                <span class="font-medium ${isBanned ? 'banned-user' : ''}">${comment.username}</span>
                                ${isBanned ? '<span class="ml-2 text-xs bg-danger/10 text-danger px-1.5 py-0.5 rounded">å·²ç¦è¨€</span>' : ''}
                            </div>
                            <span class="text-xs text-gray-500">${formattedDate}</span>
                        </div>
                        <p class="mt-1 text-gray-700">${comment.content}</p>
                        ${fileHtml}
                        ${linkHtml}
                        <div class="mt-2 flex items-center gap-4">
                            <button class="like-button flex items-center text-sm ${likeClass}" data-id="${comment.id}">
                                <i class="fa ${likeIcon} mr-1"></i>
                                <span>${comment.likes}</span>
                            </button>
                            <button class="reply-button flex items-center text-sm text-gray-500" data-id="${comment.id}">
                                <i class="fa fa-reply mr-1"></i>
                                <span>å›å¤</span>
                            </button>
                            ${currentUser.isAdmin || currentUser.id !== comment.userId ? `
                                <button class="report-button flex items-center text-sm text-gray-500" data-id="${comment.id}">
                                    <i class="fa fa-flag mr-1"></i>
                                    <span>ä¸¾æŠ¥</span>
                                </button>
                            ` : ''}
                            ${currentUser.isAdmin ? `
                                <button class="delete-comment-button flex items-center text-sm text-gray-500" data-id="${comment.id}">
                                    <i class="fa fa-trash mr-1"></i>
                                    <span>åˆ é™¤</span>
                                </button>
                            ` : ''}
                        </div>
                        <div class="reply-form mt-3 hidden" data-id="${comment.id}">
                            <textarea rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" placeholder="å›å¤..."></textarea>
                            <div class="mt-1 flex justify-end gap-2">
                                <button class="cancel-reply px-2 py-1 border rounded text-xs">å–æ¶ˆ</button>
                                <button class="submit-reply px-2 py-1 bg-primary text-white rounded text-xs">å›å¤</button>
                            </div>
                        </div>
                        <div class="replies mt-3 space-y-3" data-id="${comment.id}">
                            ${comment.replies.map(reply => createReplyHtml(reply)).join('')}
                        </div>
                        ${comment.replies.length > MAX_REPLIES_BEFORE_COLLAPSE ? `
                            <button class="show-more-replies text-xs text-primary mt-1" data-id="${comment.id}">
                                æ˜¾ç¤ºå…¨éƒ¨ ${comment.replies.length} æ¡å›å¤
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
            
            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            div.querySelector('.like-button').addEventListener('click', handleLike);
            div.querySelector('.reply-button').addEventListener('click', toggleReplyForm);
            
            if (div.querySelector('.cancel-reply')) {
                div.querySelector('.cancel-reply').addEventListener('click', toggleReplyForm);
            }
            
            if (div.querySelector('.submit-reply')) {
                div.querySelector('.submit-reply').addEventListener('click', submitReply);
            }
            
            if (div.querySelector('.report-button')) {
                div.querySelector('.report-button').addEventListener('click', openReportModal);
            }
            
            if (div.querySelector('.delete-comment-button')) {
                div.querySelector('.delete-comment-button').addEventListener('click', deleteComment);
            }
            
            if (div.querySelector('.show-more-replies')) {
                div.querySelector('.show-more-replies').addEventListener('click', toggleShowMoreReplies);
            }
            
            // å›¾ç‰‡ç‚¹å‡»æŸ¥çœ‹
            const images = div.querySelectorAll('.comment-image');
            images.forEach(img => {
                img.addEventListener('click', () => {
                    document.getElementById('viewer-image').src = img.src;
                    document.getElementById('image-viewer').classList.add('show');
                });
            });
            
            return div;
        }

        function createReplyHtml(reply) {
            const date = new Date(reply.timestamp);
            const formattedDate = `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
            
            return `
                <div class="reply-indent" data-id="${reply.id}">
                    <div class="flex items-start gap-2">
                        <img src="${reply.avatar}" alt="${reply.username}" class="w-8 h-8 rounded-full object-cover">
                        <div class="flex-1">
                            <div class="flex items-center justify-between">
                                <span class="font-medium text-sm">${reply.username}</span>
                                <span class="text-xs text-gray-500">${formattedDate}</span>
                            </div>
                            <p class="mt-0.5 text-gray-700 text-sm">${reply.content}</p>
                            <div class="mt-1 flex items-center gap-4">
                                ${currentUser.isAdmin ? `
                                    <button class="delete-reply-button flex items-center text-xs text-gray-500" data-comment-id="${reply.commentId}" data-reply-id="${reply.id}">
                                        <i class="fa fa-trash mr-1"></i>
                                        <span>åˆ é™¤</span>
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function sortComments(type) {
            sortBy = type;
            document.getElementById('sort-time').className = type === 'time' ? 
                'px-3 py-1 bg-primary text-white text-sm' : 
                'px-3 py-1 bg-gray-100 text-gray-700 text-sm hover:bg-gray-200';
                
            document.getElementById('sort-likes').className = type === 'likes' ? 
                'px-3 py-1 bg-primary text-white text-sm' : 
                'px-3 py-1 bg-gray-100 text-gray-700 text-sm hover:bg-gray-200';
                
            currentPage = 1;
            loadComments();
        }

        function changePage(direction) {
            currentPage += direction;
            loadComments();
            
            // æ»šåŠ¨åˆ°è¯„è®ºåŒºé¡¶éƒ¨
            document.getElementById('comments-container').scrollIntoView({ behavior: 'smooth' });
        }

        function handleLike(e) {
            const commentId = e.currentTarget.dataset.id;
            const comments = JSON.parse(localStorage.getItem('comments'));
            const comment = comments.find(c => c.id === commentId);
            
            if (!comment) return;
            
            const index = comment.likedBy.indexOf(currentUser.id);
            if (index === -1) {
                comment.likes++;
                comment.likedBy.push(currentUser.id);
            } else {
                comment.likes--;
                comment.likedBy.splice(index, 1);
            }
            
            localStorage.setItem('comments', JSON.stringify(comments));
            loadComments();
        }

        function toggleReplyForm(e) {
            const commentId = e.currentTarget.closest('[data-id]').dataset.id;
            const replyForm = document.querySelector(`.reply-form[data-id="${commentId}"]`);
            replyForm.classList.toggle('hidden');
            
            if (!replyForm.classList.contains('hidden')) {
                replyForm.querySelector('textarea').focus();
            }
        }

        function submitReply(e) {
            const commentElement = e.currentTarget.closest('[data-id]');
            const commentId = commentElement.dataset.id;
            const replyForm = commentElement.querySelector(`.reply-form[data-id="${commentId}"]`);
            const content = replyForm.querySelector('textarea').value.trim();
            
            if (!content) return;
            
            const comments = JSON.parse(localStorage.getItem('comments'));
            const comment = comments.find(c => c.id === commentId);
            
            if (!comment) return;
            
            const newReply = {
                id: Date.now().toString(),
                commentId: commentId,
                userId: currentUser.id,
                username: currentUser.username,
                avatar: currentUser.avatar || DEFAULT_AVATAR,
                content: content,
                timestamp: new Date().toISOString()
            };
            
            comment.replies.unshift(newReply);
            localStorage.setItem('comments', JSON.stringify(comments));
            
            replyForm.querySelector('textarea').value = '';
            replyForm.classList.add('hidden');
            
            loadComments();
        }

        function openReportModal(e) {
            const commentId = e.currentTarget.dataset.id;
            const comments = JSON.parse(localStorage.getItem('comments'));
            const comment = comments.find(c => c.id === commentId);
            
            if (!comment) return;
            
            document.getElementById('report-comment-content').textContent = comment.content;
            document.getElementById('report-reason').value = '';
            document.getElementById('report-modal').dataset.commentId = commentId;
            document.getElementById('report-modal').classList.add('show');
            document.getElementById('overlay').classList.add('show');
        }

        function closeReportModal() {
            document.getElementById('report-modal').classList.remove('show');
            document.getElementById('overlay').classList.remove('show');
        }

        function submitReport() {
            const commentId = document.getElementById('report-modal').dataset.commentId;
            const reason = document.getElementById('report-reason').value.trim();
            
            if (!reason) {
                alert('è¯·è¾“å…¥ä¸¾æŠ¥åŸå› ');
                return;
            }
            
            const reports = JSON.parse(localStorage.getItem('reports'));
            const comments = JSON.parse(localStorage.getItem('comments'));
            const comment = comments.find(c => c.id === commentId);
            
            if (!comment) return;
            
            reports.push({
                id: Date.now().toString(),
                commentId: commentId,
                commentContent: comment.content,
                reporterId: currentUser.id,
                reporterName: currentUser.username,
                reason: reason,
                timestamp: new Date().toISOString(),
                status: 'pending'
            });
            
            localStorage.setItem('reports', JSON.stringify(reports));
            closeReportModal();
            alert('ä¸¾æŠ¥å·²æäº¤ï¼Œç­‰å¾…ç®¡ç†å‘˜å®¡æ ¸');
            
            // å¦‚æœæ˜¯ç®¡ç†å‘˜ï¼Œå®æ—¶æ›´æ–°ä¸¾æŠ¥åˆ—è¡¨
            if (currentUser.isAdmin) {
                loadAdminPanelData();
            }
        }

        function handleReportReview(action) {
            const reportId = document.getElementById('review-report-modal').dataset.reportId;
            const commentId = document.getElementById('review-report-modal').dataset.commentId;
            
            const reports = JSON.parse(localStorage.getItem('reports'));
            const reportIndex = reports.findIndex(r => r.id === reportId);
            
            if (reportIndex === -1) return;
            
            reports[reportIndex].status = action;
            localStorage.setItem('reports', JSON.stringify(reports));
            
            // å¦‚æœéœ€è¦åˆ é™¤è¯„è®º
            if (action === 'delete') {
                let comments = JSON.parse(localStorage.getItem('comments'));
                comments = comments.filter(c => c.id !== commentId);
                localStorage.setItem('comments', JSON.stringify(comments));
                loadComments();
            }
            
            document.getElementById('review-report-modal').classList.remove('show');
            loadAdminPanelData();
        }

        function deleteComment(e) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿ')) return;
            
            const commentId = e.currentTarget.dataset.id;
            let comments = JSON.parse(localStorage.getItem('comments'));
            comments = comments.filter(c => c.id !== commentId);
            localStorage.setItem('comments', JSON.stringify(comments));
            loadComments();
        }

        function toggleShowMoreReplies(e) {
            const commentId = e.currentTarget.dataset.id;
            const repliesContainer = document.querySelector(`.replies[data-id="${commentId}"]`);
            const button = e.currentTarget;
            
            if (repliesContainer.classList.contains('show-all')) {
                repliesContainer.classList.remove('show-all');
                const comments = JSON.parse(localStorage.getItem('comments'));
                const comment = comments.find(c => c.id === commentId);
                repliesContainer.innerHTML = comment.replies.slice(0, MAX_REPLIES_BEFORE_COLLAPSE).map(reply => createReplyHtml(reply)).join('');
                button.textContent = `æ˜¾ç¤ºå…¨éƒ¨ ${comment.replies.length} æ¡å›å¤`;
            } else {
                repliesContainer.classList.add('show-all');
                const comments = JSON.parse(localStorage.getItem('comments'));
                const comment = comments.find(c => c.id === commentId);
                repliesContainer.innerHTML = comment.replies.map(reply => createReplyHtml(reply)).join('');
                button.textContent = 'æ”¶èµ·å›å¤';
            }
        }

        function openAdminPanel() {
            document.getElementById('admin-panel').classList.add('open');
            document.getElementById('overlay').classList.add('show');
            loadAdminPanelData();
        }

        function closeAdminPanel() {
            document.getElementById('admin-panel').classList.remove('open');
            document.getElementById('overlay').classList.remove('show');
            document.getElementById('review-report-modal').classList.remove('show');
        }

        function loadAdminPanelData() {
            const users = JSON.parse(localStorage.getItem('users'));
            const comments = JSON.parse(localStorage.getItem('comments'));
            const reports = JSON.parse(localStorage.getItem('reports'));
            const pendingReports = reports.filter(r => r.status === 'pending');
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            document.getElementById('total-users').textContent = Object.keys(users).length;
            document.getElementById('total-comments').textContent = comments.length;
            document.getElementById('pending-reports').textContent = pendingReports.length;
            document.getElementById('online-users').textContent = '1'; // ç®€åŒ–å¤„ç†ï¼Œå®é™…åº”é€šè¿‡åç«¯è®¡ç®—
            
            // åŠ è½½ç”¨æˆ·åˆ—è¡¨
            const userList = document.getElementById('user-list');
            userList.innerHTML = '';
            
            Object.values(users).forEach(user => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-2 hover:bg-gray-50 rounded';
                div.innerHTML = `
                    <div class="flex items-center gap-2">
                        <img src="${user.avatar}" alt="${user.username}" class="w-6 h-6 rounded-full">
                        <span>${user.username} ${user.isAdmin ? '<span class="admin-badge">ç®¡ç†å‘˜</span>' : ''}</span>
                    </div>
                    <button class="view-user-details text-xs text-primary" data-id="${user.id}">è¯¦æƒ…</button>
                `;
                userList.appendChild(div);
                
                div.querySelector('.view-user-details').addEventListener('click', () => {
                    showUserDetails(user.id);
                });
            });
            
            // åŠ è½½ä¸¾æŠ¥åˆ—è¡¨
            const reportList = document.getElementById('report-list');
            reportList.innerHTML = '';
            
            pendingReports.forEach(report => {
                const div = document.createElement('div');
                div.className = 'border-b border-gray-100 pb-2 mb-2 last:border-0 last:mb-0';
                div.innerHTML = `
                    <div class="text-sm font-medium">ä¸¾æŠ¥ #${report.id.substring(0, 6)}</div>
                    <div class="text-xs text-gray-600 mt-1">${report.commentContent.substring(0, 50)}${report.commentContent.length > 50 ? '...' : ''}</div>
                    <div class="flex justify-end mt-1">
                        <button class="review-report text-xs text-primary" data-id="${report.id}" data-comment-id="${report.commentId}">å®¡æ ¸</button>
                    </div>
                `;
                reportList.appendChild(div);
                
                div.querySelector('.review-report').addEventListener('click', (e) => {
                    const reportId = e.currentTarget.dataset.id;
                    const commentId = e.currentTarget.dataset.commentId;
                    const report = reports.find(r => r.id === reportId);
                    
                    document.getElementById('review-comment-content').textContent = report.commentContent;
                    document.getElementById('review-report-reason').textContent = report.reason;
                    document.getElementById('review-reporter').textContent = report.reporterName;
                    document.getElementById('review-report-modal').dataset.reportId = reportId;
                    document.getElementById('review-report-modal').dataset.commentId = commentId;
                    document.getElementById('review-report-modal').classList.add('show');
                });
            });
            
            // åŠ è½½å…¬å‘Šå†…å®¹
            document.getElementById('announcement-content').value = localStorage.getItem('announcement') || '';
        }

        function showUserDetails(userId) {
            const users = JSON.parse(localStorage.getItem('users'));
            const user = users[userId];
            const bannedUsers = JSON.parse(localStorage.getItem('bannedUsers'));
            const isBanned = bannedUsers.some(u => u.id === userId);
            
            if (!user) return;
            
            const comments = JSON.parse(localStorage.getItem('comments'));
            const userComments = comments.filter(c => c.userId === userId).length;
            
            document.getElementById('user-modal-title').textContent = `${user.username} çš„è¯¦æƒ…`;
            document.getElementById('user-modal-content').innerHTML = `
                <div class="flex flex-col items-center mb-4">
                    <img src="${user.avatar}" alt="${user.username}" class="w-20 h-20 rounded-full mb-2">
                    <div class="font-medium">${user.username}</div>
                    <div class="text-sm text-gray-500">ID: ${user.id}</div>
                </div>
                <div class="space-y-2 text-sm">
                    <div><span class="text-gray-500">æ³¨å†Œæ—¶é—´:</span> ${new Date(user.joinDate).toLocaleString()}</div>
                    <div><span class="text-gray-500">è¯„è®ºæ•°:</span> ${userComments}</div>
                    <div><span class="text-gray-500">è§’è‰²:</span> ${user.isAdmin ? 'ç®¡ç†å‘˜' : 'æ™®é€šç”¨æˆ·'}</div>
                    <div><span class="text-gray-500">çŠ¶æ€:</span> ${isBanned ? '<span class="text-danger">å·²ç¦è¨€</span>' : '<span class="text-success">æ­£å¸¸</span>'}</div>
                </div>
                <div class="mt-4 flex justify-end gap-2">
                    ${!user.isAdmin ? `
                        <button id="toggle-ban-user" class="px-3 py-1 ${isBanned ? 'bg-success' : 'bg-danger'} text-white rounded text-sm">
                            ${isBanned ? 'è§£é™¤ç¦è¨€' : 'ç¦è¨€ç”¨æˆ·'}
                        </button>
                    ` : ''}
                    <button id="close-user-modal" class="px-3 py-1 border rounded text-sm">å…³é—­</button>
                </div>
            `;
            
            document.getElementById('user-modal').classList.add('show');
            document.getElementById('overlay').classList.add('show');
            
            // ç¦è¨€/è§£é™¤ç¦è¨€æŒ‰é’®äº‹ä»¶
            if (document.getElementById('toggle-ban-user')) {
                document.getElementById('toggle-ban-user').addEventListener('click', () => {
                    toggleUserBanStatus(userId);
                    document.getElementById('user-modal').classList.remove('show');
                    loadAdminPanelData();
                    loadBannedUsers();
                    loadComments();
                });
            }
            
            document.getElementById('close-user-modal').addEventListener('click', () => {
                document.getElementById('user-modal').classList.remove('show');
            });
        }

        function toggleUserBanStatus(userId) {
            let bannedUsers = JSON.parse(localStorage.getItem('bannedUsers'));
            const index = bannedUsers.findIndex(u => u.id === userId);
            
            if (index === -1) {
                // ç¦è¨€ç”¨æˆ·
                const users = JSON.parse(localStorage.getItem('users'));
                const user = users[userId];
                bannedUsers.push({
                    id: userId,
                    username: user.username,
                    bannedAt: new Date().toISOString()
                });
            } else {
                // è§£é™¤ç¦è¨€
                bannedUsers.splice(index, 1);
            }
            
            localStorage.setItem('bannedUsers', JSON.stringify(bannedUsers));
        }

        function saveAnnouncement() {
            const content = document.getElementById('announcement-content').value.trim();
            localStorage.setItem('announcement', content);
            loadAnnouncement();
            alert('å…¬å‘Šå·²ä¿å­˜');
        }

        function deleteAnnouncement() {
            if (confirm('ç¡®å®šè¦åˆ é™¤å…¬å‘Šå—ï¼Ÿ')) {
                localStorage.setItem('announcement', '');
                document.getElementById('announcement-content').value = '';
                loadAnnouncement();
            }
        }

        function loadAnnouncement() {
            const announcement = localStorage.getItem('announcement');
            const container = document.getElementById('announcement');
            
            if (announcement) {
                document.getElementById('announcement-text').textContent = announcement;
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
        }

        function loadBannedUsers() {
            const bannedUsers = JSON.parse(localStorage.getItem('bannedUsers'));
            const container = document.getElementById('banned-users-section');
            const list = document.getElementById('banned-users-list');
            
            if (bannedUsers.length > 0) {
                list.innerHTML = bannedUsers.map(user => `
                    <div class="flex items-center justify-between py-1">
                        <span class="banned-user">${user.username}</span>
                        <span class="text-xs text-gray-500">${new Date(user.bannedAt).toLocaleString()}</span>
                    </div>
                `).join('');
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
        }

        function handleAvatarUpload(e) {
            handleAvatarFile(e.target.files[0], (url) => {
                updateUserAvatar(url);
            });
        }

        function handleAvatarUploadModal(e) {
            handleAvatarFile(e.target.files[0], (url) => {
                document.getElementById('avatar-preview').src = url;
            });
        }

        function handleAvatarFile(file, callback) {
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                alert('è¯·ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    // å‹ç¼©å›¾ç‰‡
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // ä¿æŒæ¯”ä¾‹ç¼©æ”¾ï¼Œæœ€å¤§å°ºå¯¸200x200
                    const maxSize = 200;
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > height) {
                        if (width > maxSize) {
                            height = height * (maxSize / width);
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width = width * (maxSize / height);
                            height = maxSize;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // è½¬æ¢ä¸ºbase64
                    const dataUrl = canvas.toDataURL(file.type, IMAGE_QUALITY);
                    callback(dataUrl);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function updateUserAvatar(url) {
            currentUser.avatar = url;
            
            const users = JSON.parse(localStorage.getItem('users'));
            users[currentUser.id] = currentUser;
            localStorage.setItem('users', JSON.stringify(users));
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            document.getElementById('user-avatar').src = url;
            loadComments();
        }

        function handleFileUpload(e) {
            const file = e.target.files[0];
            const preview = document.getElementById('file-preview');
            
            if (!file) {
                preview.classList.add('hidden');
                return;
            }
            
            if (file.size > MAX_FILE_SIZE) {
                document.getElementById('file-error').textContent = 'æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡10MB';
                document.getElementById('file-error').classList.remove('hidden');
                return;
            }
            
            document.getElementById('file-error').classList.add('hidden');
            
            // å¯¹äºå›¾ç‰‡ï¼Œæ˜¾ç¤ºé¢„è§ˆ
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fa fa-file-image-o text-primary mr-2"></i>
                                <span class="text-sm">${file.name}</span>
                            </div>
                            <button id="remove-file" class="text-gray-500 hover:text-danger">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>
                        <img src="${e.target.result}" alt="${file.name}" class="max-w-full max-h-32 mt-2 rounded">
                    `;
                    preview.dataset.filename = file.name;
                    preview.dataset.fileurl = e.target.result;
                    preview.dataset.filetype = file.type;
                    preview.classList.remove('hidden');
                    preview.classList.add('show');
                    
                    document.getElementById('remove-file').addEventListener('click', () => {
                        document.getElementById('file-upload').value = '';
                        preview.classList.add('hidden');
                        preview.classList.remove('show');
                    });
                };
                reader.readAsDataURL(file);
            } else {
                // éå›¾ç‰‡æ–‡ä»¶ï¼Œåªæ˜¾ç¤ºæ–‡ä»¶å
                preview.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <i class="fa fa-file-o text-gray-500 mr-2"></i>
                            <span class="text-sm">${file.name}</span>
                        </div>
                        <button id="remove-file" class="text-gray-500 hover:text-danger">
                            <i class="fa fa-times"></i>
                        </button>
                    </div>
                `;
                preview.dataset.filename = file.name;
                preview.dataset.fileurl = '#'; // å®é™…åº”ç”¨ä¸­åº”ä¸Šä¼ åˆ°æœåŠ¡å™¨è·å–URL
                preview.dataset.filetype = file.type;
                preview.classList.remove('hidden');
                preview.classList.add('show');
                
                document.getElementById('remove-file').addEventListener('click', () => {
                    document.getElementById('file-upload').value = '';
                    preview.classList.add('hidden');
                    preview.classList.remove('show');
                });
            }
        }

        function closeImageViewer() {
            document.getElementById('image-viewer').classList.remove('show');
        }

        // åˆå§‹åŒ–åº”ç”¨
        window.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
