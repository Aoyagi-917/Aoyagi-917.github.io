<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>本地评论系统</title>
    <!-- 引入Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 配置Tailwind自定义颜色 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#64748b',
                        neutral: '#f1f5f9',
                    },
                }
            }
        }
    </script>
    
    <!-- 自定义工具类 -->
    <style type="text/tailwindcss">
        @layer utilities {
            .comment-shadow {
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            }
            .reply-indent {
                margin-left: 1.5rem;
                border-left: 2px solid #e2e8f0;
                padding-left: 1rem;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 md:p-8">
    <div class="max-w-3xl mx-auto bg-white rounded-xl p-6 shadow-md">
        <h1 class="text-2xl font-bold text-gray-800 mb-6">评论区</h1>
        
        <!-- 评论输入区 -->
        <div class="mb-8 bg-neutral rounded-lg p-4">
            <div class="mb-4">
                <label for="comment-content" class="block text-sm font-medium text-gray-700 mb-1">评论内容</label>
                <textarea 
                    id="comment-content" 
                    rows="3" 
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50"
                    placeholder="分享你的想法..."></textarea>
            </div>
            <div class="mb-4">
                <label for="comment-author" class="block text-sm font-medium text-gray-700 mb-1">昵称</label>
                <input 
                    type="text" 
                    id="comment-author" 
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50"
                    placeholder="你的昵称">
            </div>
            <button id="submit-comment" class="bg-primary text-white px-4 py-2 rounded-md hover:bg-primary/90 transition-colors">
                发布评论
            </button>
        </div>
        
        <!-- 评论列表 -->
        <div id="comments-container" class="space-y-6">
            <!-- 评论会通过JS动态生成 -->
            <div class="text-center text-gray-500 py-8" id="empty-state">
                <span class="text-4xl mb-2 opacity-30">💬</span>
                <p>还没有评论，快来抢沙发吧~</p>
            </div>
        </div>
        
        <!-- 分页控件 -->
        <div id="pagination" class="flex justify-center mt-8 gap-2 hidden">
            <button id="prev-page" class="px-3 py-1 border rounded-md hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">上一页</button>
            <span id="page-info" class="px-3 py-1"></span>
            <button id="next-page" class="px-3 py-1 border rounded-md hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">下一页</button>
        </div>
    </div>

    <script>
        // 初始化localStorage（如果没有数据则创建空数组）
        if (!localStorage.getItem('comments')) {
            localStorage.setItem('comments', JSON.stringify([]));
        }

        // 分页配置
        const PAGE_SIZE = 10;
        let currentPage = 1;

        // 获取当前时间（简化版，确保时区正确）
        function getCurrentTime() {
            const now = new Date();
            return now.toISOString().slice(0, 19).replace('T', ' ');
        }

        // 生成唯一ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }

        // 检查评论是否可以撤回（简化逻辑，确保按钮显示）
        function canWithdraw(timeString) {
            // 为了确保按钮可见，这里暂时改为始终返回true
            // 实际使用时可以改为5分钟限制：
            // const commentTime = new Date(timeString).getTime();
            // const now = new Date().getTime();
            // return now - commentTime <= 1000 * 60 * 5; // 5分钟
            
            return true; // 始终显示撤回按钮
        }

        // 获取当前页的评论
        function getCurrentPageComments() {
            const comments = JSON.parse(localStorage.getItem('comments') || '[]');
            const startIndex = (currentPage - 1) * PAGE_SIZE;
            const endIndex = startIndex + PAGE_SIZE;
            return comments.slice(startIndex, endIndex);
        }

        // 获取总页数
        function getTotalPages() {
            const comments = JSON.parse(localStorage.getItem('comments') || '[]');
            return Math.ceil(comments.length / PAGE_SIZE);
        }

        // 更新分页控件状态
        function updatePagination() {
            const totalPages = getTotalPages();
            const paginationEl = document.getElementById('pagination');
            const prevBtn = document.getElementById('prev-page');
            const nextBtn = document.getElementById('next-page');
            const pageInfo = document.getElementById('page-info');

            paginationEl.classList.toggle('hidden', totalPages <= 1);
            
            if (totalPages <= 1) return;

            pageInfo.textContent = `第 ${currentPage} / ${totalPages} 页`;
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;
        }

        // 渲染评论列表
        function renderComments() {
            const commentsContainer = document.getElementById('comments-container');
            const allComments = JSON.parse(localStorage.getItem('comments') || '[]');
            const currentComments = getCurrentPageComments();
            const emptyState = document.getElementById('empty-state');

            // 清空容器（保留empty-state）
            Array.from(commentsContainer.children).forEach(child => {
                if (child.id !== 'empty-state') child.remove();
            });

            // 显示/隐藏空状态
            emptyState.style.display = allComments.length === 0 ? 'block' : 'none';

            // 渲染当前页的每条评论
            currentComments.forEach(comment => {
                const commentEl = createCommentElement(comment);
                commentsContainer.appendChild(commentEl);
            });

            updatePagination();
        }

        // 创建单条评论元素
        function createCommentElement(comment, isReply = false) {
            const div = document.createElement('div');
            div.className = `comment-shadow rounded-lg p-4 ${isReply ? 'reply-indent mt-3' : ''}`;
            div.dataset.id = comment.id;

            // 确保必要属性存在
            comment.replies = comment.replies || [];
            comment.showAllReplies = comment.showAllReplies || false;
            
            // 检查是否可以撤回（现在始终为true）
            const withdrawable = canWithdraw(comment.time);
            
            // 处理回复折叠逻辑
            const replies = comment.replies;
            const showAllReplies = comment.showAllReplies;
            const visibleReplies = showAllReplies ? replies : replies.slice(0, 3);
            const hasMoreReplies = replies.length > 3;
            
            div.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <h3 class="font-semibold text-gray-800">${comment.author}</h3>
                    <span class="text-xs text-gray-500">${comment.time}</span>
                </div>
                <p class="text-gray-700 mb-3">${comment.content}</p>
                <div class="flex items-center gap-4 text-sm">
                    <button class="like-btn flex items-center gap-1 text-gray-600 hover:text-red-500 transition-colors" 
                            data-id="${comment.id}">
                        <span>${comment.isLiked ? '❤️' : '🤍'}</span>
                        <span>${comment.likes}</span>
                    </button>
                    <button class="reply-btn flex items-center gap-1 text-gray-600 hover:text-primary transition-colors">
                        <span>💬</span>
                        <span>回复</span>
                    </button>
                    ${withdrawable ? `
                    <button class="withdraw-btn flex items-center gap-1 text-gray-600 hover:text-red-500 transition-colors">
                        <span>🗑️</span>
                        <span>撤回</span>
                    </button>
                    ` : ''}
                </div>
                <!-- 回复输入框（默认隐藏） -->
                <div class="reply-form mt-3 hidden">
                    <textarea class="reply-content w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-primary/50"
                              rows="2" placeholder="回复 @${comment.author}..."></textarea>
                    <div class="flex gap-2 mt-2">
                        <input type="text" class="reply-author w-1/3 px-3 py-1 border border-gray-300 rounded-md text-sm focus:outline-none"
                               placeholder="你的昵称">
                        <button class="submit-reply bg-primary/90 text-white px-3 py-1 rounded-md text-sm hover:bg-primary transition-colors">
                            回复
                        </button>
                        <button class="cancel-reply text-gray-500 px-3 py-1 rounded-md text-sm hover:bg-gray-100 transition-colors">
                            取消
                        </button>
                    </div>
                </div>
                <!-- 回复列表 -->
                <div class="replies mt-4 space-y-2">
                    ${visibleReplies.map(reply => createCommentElement(reply, true).outerHTML).join('')}
                    ${hasMoreReplies ? `
                        <button class="toggle-replies text-sm text-primary mt-1 flex items-center gap-1" data-id="${comment.id}">
                            <span>⬇️</span>
                            <span>显示${showAllReplies ? '更少' : '全部'}回复 (${showAllReplies ? 3 : replies.length - 3}条)</span>
                        </button>
                    ` : ''}
                </div>
            `;

            // 绑定回复折叠/展开事件
            if (hasMoreReplies) {
                const toggleBtn = div.querySelector('.toggle-replies');
                toggleBtn.addEventListener('click', function() {
                    const commentId = this.dataset.id;
                    toggleRepliesVisibility(commentId);
                });
            }

            return div;
        }

        // 回复折叠/展开函数
        function toggleRepliesVisibility(commentId) {
            const comments = JSON.parse(localStorage.getItem('comments') || '[]');
            
            // 递归查找评论并切换显示状态
            function findAndToggle(commentList) {
                for (let comment of commentList) {
                    if (comment.id === commentId) {
                        comment.showAllReplies = !comment.showAllReplies;
                        return true;
                    }
                    if (comment.replies && comment.replies.length > 0) {
                        if (findAndToggle(comment.replies)) {
                            return true;
                        }
                    }
                }
                return false;
            }
            
            findAndToggle(comments);
            localStorage.setItem('comments', JSON.stringify(comments));
            renderComments();
        }

        // 发布评论
        function publishComment(content, author) {
            if (!content.trim() || !author.trim()) {
                alert('请输入评论内容和昵称');
                return;
            }

            const comments = JSON.parse(localStorage.getItem('comments') || '[]');
            const newComment = {
                id: generateId(),
                content: content.trim(),
                author: author.trim(),
                time: getCurrentTime(),
                likes: 0,
                isLiked: false,
                replies: [],
                showAllReplies: false
            };

            comments.unshift(newComment);
            localStorage.setItem('comments', JSON.stringify(comments));
            
            currentPage = 1;
            renderComments();

            // 清空输入框
            document.getElementById('comment-content').value = '';
            document.getElementById('comment-author').value = '';
        }

        // 发布回复
        function publishReply(commentId, content, author) {
            if (!content.trim() || !author.trim()) {
                alert('请输入回复内容和昵称');
                return;
            }

            const comments = JSON.parse(localStorage.getItem('comments') || '[]');
            const newReply = {
                id: generateId(),
                content: content.trim(),
                author: author.trim(),
                time: getCurrentTime(),
                likes: 0,
                isLiked: false,
                replies: [],
                showAllReplies: false
            };

            // 递归查找评论并添加回复
            function findAndAddReply(commentList) {
                for (let i = 0; i < commentList.length; i++) {
                    if (commentList[i].id === commentId) {
                        commentList[i].replies.unshift(newReply);
                        return true;
                    }
                    if (commentList[i].replies && commentList[i].replies.length > 0 && findAndAddReply(commentList[i].replies)) {
                        return true;
                    }
                }
                return false;
            }

            findAndAddReply(comments);
            localStorage.setItem('comments', JSON.stringify(comments));
            renderComments();
        }

        // 点赞功能
        function toggleLike(commentId) {
            const comments = JSON.parse(localStorage.getItem('comments') || '[]');

            function findAndToggleLike(commentList) {
                for (let comment of commentList) {
                    if (comment.id === commentId) {
                        comment.likes += comment.isLiked ? -1 : 1;
                        comment.isLiked = !comment.isLiked;
                        return true;
                    }
                    if (comment.replies && comment.replies.length > 0 && findAndToggleLike(comment.replies)) {
                        return true;
                    }
                }
                return false;
            }

            findAndToggleLike(comments);
            localStorage.setItem('comments', JSON.stringify(comments));
            renderComments();
        }

        // 撤回评论/回复功能
        function withdrawComment(commentId) {
            if (!confirm('确定要撤回这条评论吗？')) {
                return;
            }

            const comments = JSON.parse(localStorage.getItem('comments') || '[]');

            function findAndRemoveComment(commentList) {
                for (let i = 0; i < commentList.length; i++) {
                    if (commentList[i].id === commentId) {
                        commentList.splice(i, 1);
                        return true;
                    }
                    if (commentList[i].replies && commentList[i].replies.length > 0 && findAndRemoveComment(commentList[i].replies)) {
                        return true;
                    }
                }
                return false;
            }

            findAndRemoveComment(comments);
            localStorage.setItem('comments', JSON.stringify(comments));
            
            // 调整当前页
            const totalPages = getTotalPages();
            if (currentPage > totalPages && totalPages > 0) {
                currentPage = totalPages;
            }
            
            renderComments();
        }

        // 事件监听
        document.addEventListener('DOMContentLoaded', () => {
            // 初始渲染评论
            renderComments();

            // 发布评论按钮
            document.getElementById('submit-comment').addEventListener('click', () => {
                const content = document.getElementById('comment-content').value;
                const author = document.getElementById('comment-author').value;
                publishComment(content, author);
            });

            // 分页按钮事件
            document.getElementById('prev-page').addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderComments();
                }
            });

            document.getElementById('next-page').addEventListener('click', () => {
                const totalPages = getTotalPages();
                if (currentPage < totalPages) {
                    currentPage++;
                    renderComments();
                }
            });

            // 点击事件委托
            const commentsContainer = document.getElementById('comments-container');
            
            // 点赞按钮事件
            commentsContainer.addEventListener('click', (e) => {
                const likeBtn = e.target.closest('.like-btn');
                if (likeBtn) {
                    const commentId = likeBtn.dataset.id;
                    toggleLike(commentId);
                }
            });
            
            // 回复按钮事件
            commentsContainer.addEventListener('click', (e) => {
                const replyBtn = e.target.closest('.reply-btn');
                if (replyBtn) {
                    const commentEl = replyBtn.closest('[data-id]');
                    const replyForm = commentEl.querySelector('.reply-form');
                    // 隐藏其他所有回复框
                    document.querySelectorAll('.reply-form').forEach(form => {
                        if (form !== replyForm) form.classList.add('hidden');
                    });
                    // 切换当前回复框显示状态
                    replyForm.classList.toggle('hidden');
                }
            });
            
            // 取消回复事件
            commentsContainer.addEventListener('click', (e) => {
                const cancelBtn = e.target.closest('.cancel-reply');
                if (cancelBtn) {
                    cancelBtn.closest('.reply-form').classList.add('hidden');
                }
            });
            
            // 提交回复事件
            commentsContainer.addEventListener('click', (e) => {
                const submitReplyBtn = e.target.closest('.submit-reply');
                if (submitReplyBtn) {
                    const replyForm = submitReplyBtn.closest('.reply-form');
                    const commentEl = replyForm.closest('[data-id]');
                    const commentId = commentEl.dataset.id;
                    const content = replyForm.querySelector('.reply-content').value;
                    const author = replyForm.querySelector('.reply-author').value;

                    publishReply(commentId, content, author);
                    replyForm.classList.add('hidden');
                    replyForm.querySelector('.reply-content').value = '';
                    replyForm.querySelector('.reply-author').value = '';
                }
            });
            
            // 撤回按钮事件
            commentsContainer.addEventListener('click', (e) => {
                const withdrawBtn = e.target.closest('.withdraw-btn');
                if (withdrawBtn) {
                    const commentEl = withdrawBtn.closest('[data-id]');
                    const commentId = commentEl.dataset.id;
                    withdrawComment(commentId);
                }
            });

            // 添加测试数据
            // addTestComments();
        });

        // 测试用：添加测试评论数据
        function addTestComments() {
            const testComments = [];
            for (let i = 0; i < 5; i++) {
                const replies = [];
                for (let j = 0; j < 5; j++) {
                    replies.push({
                        id: generateId(),
                        content: `这是第${i+1}条评论的第${j+1}条回复`,
                        author: `测试用户${j+1}`,
                        time: getCurrentTime(),
                        likes: Math.floor(Math.random() * 10),
                        isLiked: false,
                        replies: [],
                        showAllReplies: false
                    });
                }
                
                testComments.push({
                    id: generateId(),
                    content: `这是第${i+1}条测试评论，用于测试分页和回复功能`,
                    author: `测试用户`,
                    time: getCurrentTime(),
                    likes: Math.floor(Math.random() * 20),
                    isLiked: false,
                    replies: replies,
                    showAllReplies: false
                });
            }
            
            localStorage.setItem('comments', JSON.stringify(testComments));
            renderComments();
        }
    </script>
</body>
</html>
